# Optimizely AI Revenue Intelligence Platform - Context Guide

> **CRITICAL: All AI agents must reference this file FIRST before making any changes to the codebase.**

## ğŸ—ï¸ Project Architecture Overview

### Universal API-First Platform-Agnostic Design
This is an enterprise-grade AI-powered A/B testing and revenue intelligence platform designed to work with ANY web platform, CRM, or marketing tool through universal APIs.

**Core Principle:** Everything is API-first, platform-agnostic, and universally compatible.

## ğŸ“ Project Structure

```
optimizely/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                    # Main API server (Node.js/Express/Prisma)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/         # API endpoints (56+ route files)
â”‚   â”‚   â”‚   â”œâ”€â”€ services/       # Business logic services (51+ services)
â”‚   â”‚   â”‚   â”œâ”€â”€ __tests__/      # Test files
â”‚   â”‚   â”‚   â””â”€â”€ index.ts        # Main API entry point
â”‚   â”‚   â””â”€â”€ prisma/             # Database schema and migrations
â”‚   â”œâ”€â”€ tracking/               # Universal tracking SDK (TypeScript/Rollup)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ core/           # Core tracking functionality
â”‚   â”‚   â”‚   â”œâ”€â”€ modules/        # Feature modules
â”‚   â”‚   â”‚   â””â”€â”€ __tests__/      # SDK tests
â”‚   â””â”€â”€ web/                    # Frontend dashboard (Next.js/React)
â”‚       â”œâ”€â”€ pages/              # Next.js pages
â”‚       â”œâ”€â”€ components/         # React components
â”‚       â””â”€â”€ src/                # Additional source files
â”œâ”€â”€ .taskmaster/                # Task management system
â”œâ”€â”€ scripts/                    # Build and deployment scripts
â””â”€â”€ [Multiple config files]     # ESLint, Prettier, Docker, etc.
```

## ğŸ”§ Critical Technical Patterns

### Database & Prisma
- **Primary Database:** SQLite (dev.db) with Prisma ORM
- **Schema Location:** `apps/api/prisma/schema.prisma`
- **Critical:** Always run `npx prisma generate` after schema changes
- **Connection Pattern:** All services use `database.ts` for connection management

### Service Architecture
- **Pattern:** Each service is a class with dependency injection
- **Location:** `apps/api/src/services/`
- **Naming:** `[feature]-service.ts` (e.g., `analytics-service.ts`)
- **Dependencies:** Services use Redis for caching, Prisma for data

### API Routes
- **Pattern:** Express.js routes with middleware
- **Location:** `apps/api/src/routes/`
- **Naming:** `[feature].ts` (e.g., `analytics.ts`)
- **Integration:** All routes mounted in `apps/api/src/index.ts`

### Universal Tracking SDK
- **Build System:** Rollup with TypeScript
- **Output:** `dist/tracker.min.js` and `dist/tracker.esm.js`
- **Pattern:** Modular architecture with core + modules

## ğŸš¨ Critical Dependencies & Initialization Order

### 1. Database First
```typescript
// Always ensure Prisma client is generated and available
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
```

### 2. Redis Connection
```typescript
// Redis is used for caching across all services
import { redisClient } from './redis-client';
```

### 3. Service Dependencies
- Analytics Service â†’ Database Service
- All CRM services â†’ OAuth Service
- Revenue services â†’ Analytics Service
- A/B Testing â†’ Statistical Monitoring

## ğŸ“Š Current Implementation Status

### âœ… Completed Major Systems (79/161 subtasks done)
- **Universal Visitor Intelligence** (Task 2) - COMPLETE
- **Advanced Customer Analytics** (Task 3) - COMPLETE
- **AI-Powered A/B Testing** (Task 4) - COMPLETE
- **Executive Revenue Dashboard** (Task 5) - COMPLETE
- **Sales Intelligence Interface** (Task 6) - COMPLETE
- **CRM Integration System** (Task 7) - COMPLETE
- **Revenue Automation Engine** (Task 8) - IN PROGRESS (8/10 subtasks done)

### ğŸ”„ Currently Active
- **Task 8.9:** Performance Tracking Dashboard (NEXT)
- **Task 8.10:** Rule Customization Engine (PENDING)

### ğŸ“ˆ Upcoming Priorities
- Marketing Attribution System (Task 9)
- Statistical Visualization Platform (Task 18)
- Multi-Industry Features (Task 19)

## ğŸ›¡ï¸ Critical Safeguards & Protocols

### Pre-Change Checklist
1. **Verify file existence** before modification
2. **Check service dependencies** in the dependency graph
3. **Run safety check:** `npm run safety-check`
4. **Create backup:** `git tag backup-$(date +%Y%m%d-%H%M%S)`

### Build Verification Process
```bash
# Always verify builds before committing
cd apps/api && npm run build && npm test
cd apps/tracking && npm run build && npm test
cd apps/web && npm run build
```

### Common Issues & Solutions
- **Prisma Error:** Run `npx prisma generate` in `apps/api/`
- **Port Conflicts:** API uses 3000, Web uses 3001
- **TypeScript Errors:** Check import paths and service dependencies
- **Redis Connection:** Ensure Redis is running locally

## ğŸ”— Key Service Relationships

### Core Services (Always Available)
- `database.ts` - Database connection management
- `redis-client.ts` - Redis caching layer
- `session-manager.ts` - Session handling
- `event-manager.ts` - Event processing

### Analytics Pipeline
```
Visitor â†’ BehavioralTracker â†’ AnalyticsService â†’ CustomerProfile
```

### Revenue Attribution Flow
```
Touchpoint â†’ AttributionService â†’ RevenueEvent â†’ Dashboard
```

### CRM Integration Chain
```
OAuth â†’ SyncEngine â†’ FieldMapping â†’ CRM APIs
```

## ğŸ¯ Universal API Design Principles

### 1. Platform Agnostic
- All endpoints work with any frontend/backend
- Universal CORS headers enabled
- Standardized response formats

### 2. Authentication
- OAuth 2.0 for external integrations
- JWT for internal authentication
- Multi-tenant support

### 3. Rate Limiting
- Applied to all public endpoints
- Configurable per service
- Redis-backed counters

### 4. Error Handling
- Standardized error responses
- Comprehensive logging
- Graceful fallbacks

## ğŸ” Debugging & Troubleshooting

### Log Locations
- API Logs: Console output during `npm run dev`
- Error Logs: Check service initialization in terminal
- Build Logs: TypeScript compilation output

### Common Debugging Steps
1. Check service initialization order
2. Verify database schema is current
3. Confirm Redis connection
4. Validate environment variables
5. Check port availability

## ğŸ“ Agent Instructions

### Before Making ANY Changes
1. **Read this entire context file**
2. **Check current task status** with Taskmaster
3. **Verify affected services** and their dependencies
4. **Run safety checks** before and after changes
5. **Update this context file** if adding new patterns

### When Adding New Services
1. Follow the established service pattern
2. Add to dependency graph documentation
3. Include proper error handling
4. Add comprehensive tests
5. Update route mounting in `index.ts`

### When Modifying Existing Code
1. Check all dependent services
2. Verify no breaking changes to APIs
3. Update tests accordingly
4. Document any architectural changes

### Emergency Recovery
If files are missing or corrupted:
1. Check git stash: `git stash list`
2. Look for backup tags: `git tag | grep backup`
3. Run emergency recovery: `node scripts/emergency-recovery.cjs`





## ğŸ”„ Current Project Status

- **Branch:** main
- **Uncommitted Files:** 38
- **Last Commit:** 3a1316e - feat(crm): Implement Universal Duplicate Detection System for Task 7.6 (17 hours ago)
- **Services Count:** 51
- **Routes Count:** 56
- **Tests Count:** 19
- **Components Count:** 1
- **Last Context Update:** 2025-06-28T20:46:33.041Z

---

**Remember: This platform serves millions of users across multiple industries. Every change must maintain universal compatibility and platform-agnostic design.**

*Last Updated: 2025-06-28T20:46:33.041Z*

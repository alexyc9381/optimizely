var extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])},extendStatics(d,b)},__assign=function(){return __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)};function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}function __generator(thisArg,body){var f,y,t,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]},g=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return g.next=verb(0),g.throw=verb(1),g.return=verb(2),"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;g&&(g=0,op[0]&&(_=0)),_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!((t=(t=_.trys).length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __spreadArray(to,from,pack){if(pack||2===arguments.length)for(var ar,i=0,l=from.length;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))}function generateVisitorId(){return"v_"+generateRandomId(16)}function generateSessionId(){return"s_"+generateRandomId(12)+"_"+Date.now()}function generateRandomId(length){for(var result="",i=0;i<length;i++)result+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return result}function now(){return Date.now()}function debounce(func,wait){var timeout;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];clearTimeout(timeout),timeout=window.setTimeout(function(){return func.apply(void 0,args)},wait)}}function throttle(func,limit){var inThrottle;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];inThrottle||(func.apply(void 0,args),inThrottle=!0,setTimeout(function(){return inThrottle=!1},limit))}}function isBrowser(){return"undefined"!=typeof window&&"undefined"!=typeof document}function isProduction(){return"production"===process.env.NODE_ENV}function safeJsonParse(str,fallback){try{return JSON.parse(str)}catch(_a){return fallback}}function safeJsonStringify(obj){try{return JSON.stringify(obj)}catch(_a){return"{}"}}function getCurrentUrl(){return isBrowser()?window.location.href.split("#")[0].split("?")[0]:""}function getCurrentTitle(){return isBrowser()&&document.title||""}function getReferrer(){return isBrowser()&&document.referrer||""}function getUserAgent(){return isBrowser()&&navigator.userAgent||""}function detectPlatform(){if(!isBrowser())return"server";var userAgent=getUserAgent().toLowerCase();return/android/.test(userAgent)?"android":/iphone|ipad|ipod/.test(userAgent)?"ios":/windows/.test(userAgent)?"windows":/mac/.test(userAgent)?"mac":/linux/.test(userAgent)?"linux":"unknown"}function detectBrowser(){if(!isBrowser())return"unknown";var userAgent=getUserAgent().toLowerCase();return/chrome/.test(userAgent)&&!/edge/.test(userAgent)?"chrome":/firefox/.test(userAgent)?"firefox":/safari/.test(userAgent)&&!/chrome/.test(userAgent)?"safari":/edge/.test(userAgent)?"edge":/opera/.test(userAgent)?"opera":"unknown"}function isElementVisible(element){if(!isBrowser())return!1;var rect=element.getBoundingClientRect(),windowHeight=window.innerHeight||document.documentElement.clientHeight,windowWidth=window.innerWidth||document.documentElement.clientWidth;return rect.top>=0&&rect.left>=0&&rect.bottom<=windowHeight&&rect.right<=windowWidth}function getScrollDepth(){if(!isBrowser())return 0;var scrollTop=window.pageYOffset||document.documentElement.scrollTop,documentHeight=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),windowHeight=window.innerHeight||document.documentElement.clientHeight;return documentHeight<=windowHeight?100:Math.round((scrollTop+windowHeight)/documentHeight*100)}function domReady(callback){isBrowser()&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",callback):callback()}function addEventListener(element,event,handler,options){return element.addEventListener(event,handler,options),function(){return element.removeEventListener(event,handler,options)}}function simpleHash(str){var hash=0;if(0===str.length)return hash;for(var i=0;i<str.length;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash;return Math.abs(hash)}function deepMerge(target,source){var result=__assign({},target);for(var key in source)if(source.hasOwnProperty(key)){var sourceValue=source[key],targetValue=result[key];isObject(sourceValue)&&isObject(targetValue)?result[key]=deepMerge(targetValue,sourceValue):void 0!==sourceValue&&(result[key]=sourceValue)}return result}function isObject(value){return null!==value&&"object"==typeof value&&!Array.isArray(value)}"function"==typeof SuppressedError&&SuppressedError;var BehavioralTracker=function(){function BehavioralTracker(config){void 0===config&&(config={}),this.name="behavioral",this._tracker=null,this._isActive=!1,this._startTime=0,this._lastActivity=0,this._scrollEvents=0,this._mouseEvents=0,this._maxScrollDepth=0,this._clickCount=0,this._formInteractions=0,this._mouseMovements=0,this._trackedElements=new Set,this._visibilityTimers=new Map,this._listeners=[],this._lastScrollTime=0,this._config=__assign({enableClickTracking:!0,enableScrollTracking:!0,enableFormTracking:!0,enableMouseTracking:!0,enableVisibilityTracking:!0,enablePerformanceTracking:!0,scrollThreshold:25,mouseSampleRate:100,clickSelector:'a, button, [role="button"], input[type="submit"], input[type="button"]',formSelector:"form, input, textarea, select",excludeSelectors:[".tracking-ignore",'[data-tracking="false"]'],maxScrollEvents:100,maxMouseEvents:500},config)}return BehavioralTracker.prototype.init=function(){var _a;isBrowser()&&(this._isActive=!0,this._startTime=now(),this._lastActivity=now(),this._setupEventListeners(),this._startEngagementTracking(),(null===(_a=this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.log("BehavioralTracker initialized",this._config))},BehavioralTracker.prototype.setTracker=function(tracker){this._tracker=tracker},BehavioralTracker.prototype._setupEventListeners=function(){this._config.enableClickTracking&&this._setupClickTracking(),this._config.enableScrollTracking&&this._setupScrollTracking(),this._config.enableFormTracking&&this._setupFormTracking(),this._config.enableMouseTracking&&this._setupMouseTracking(),this._config.enableVisibilityTracking&&this._setupVisibilityTracking(),this._config.enablePerformanceTracking&&this._setupPerformanceTracking(),this._setupActivityTracking()},BehavioralTracker.prototype._setupClickTracking=function(){var _this=this,handleClick=function(event){if(_this._isActive&&_this._tracker){var target=event.target;if(target&&!_this._isExcluded(target)){if(!target.matches(_this._config.clickSelector)){for(var parent_1=target.parentElement,found=!1,i=0;i<3&&parent_1;i++){if(parent_1.matches(_this._config.clickSelector)){found=!0;break}parent_1=parent_1.parentElement}if(!found)return}var clickData={element:_this._getElementSelector(target),tagName:target.tagName.toLowerCase(),className:target.className,id:target.id||"",text:_this._getElementText(target),x:event.clientX,y:event.clientY,timestamp:now()};_this._trackEvent("click",clickData),_this._clickCount++,_this._updateActivity(),_this._tracker.config.debug&&console.log("Click tracked:",clickData)}}};document.addEventListener("click",handleClick,{passive:!0}),this._listeners.push(function(){return document.removeEventListener("click",handleClick)})},BehavioralTracker.prototype._setupScrollTracking=function(){var _this=this,lastScrollTop=0,handleScroll=throttle(function(){if(_this._isActive&&_this._tracker&&!(_this._scrollEvents>=_this._config.maxScrollEvents)){var scrollTop=window.pageYOffset||document.documentElement.scrollTop,scrollHeight=document.documentElement.scrollHeight-window.innerHeight,currentDepth=Math.round(scrollTop/scrollHeight*100);if(_this._maxScrollDepth=Math.max(_this._maxScrollDepth,currentDepth),Math.abs(currentDepth-Math.round(lastScrollTop/scrollHeight*100))<_this._config.scrollThreshold)lastScrollTop=scrollTop;else{var currentTime=now(),direction=scrollTop>lastScrollTop?"down":"up",speed=Math.abs(scrollTop-lastScrollTop)/(currentTime-_this._lastScrollTime),scrollData={depth:currentDepth,maxDepth:_this._maxScrollDepth,direction:direction,speed:speed,timestamp:currentTime};_this._trackEvent("scroll",scrollData),_this._scrollEvents++,_this._updateActivity(),lastScrollTop=scrollTop,_this._lastScrollTime=currentTime,_this._tracker.config.debug&&console.log("Scroll tracked:",scrollData)}}},250);window.addEventListener("scroll",handleScroll,{passive:!0}),this._listeners.push(function(){return window.removeEventListener("scroll",handleScroll)})},BehavioralTracker.prototype._setupFormTracking=function(){var _this=this,handleFormEvent=function(event,action){var _a;if(_this._isActive&&_this._tracker){var target=event.target;if(target&&!_this._isExcluded(target)){var form=target.closest("form"),formData={formId:(null==form?void 0:form.id)||"",formName:(null==form?void 0:form.getAttribute("name"))||"",field:_this._getElementSelector(target),fieldType:target.type||target.tagName.toLowerCase(),action:action,value:"change"===action?null===(_a=target.value)||void 0===_a?void 0:_a.slice(0,50):void 0,timestamp:now()};_this._trackEvent("form_interaction",formData),_this._formInteractions++,_this._updateActivity(),_this._tracker.config.debug&&console.log("Form interaction tracked:",formData)}}};["focus","blur","change"].forEach(function(eventType){var handler=function(event){return handleFormEvent(event,eventType)};document.addEventListener(eventType,handler,{passive:!0}),_this._listeners.push(function(){return document.removeEventListener(eventType,handler)})});var handleSubmit=function(event){return handleFormEvent(event,"submit")};document.addEventListener("submit",handleSubmit,{passive:!0}),this._listeners.push(function(){return document.removeEventListener("submit",handleSubmit)})},BehavioralTracker.prototype._setupMouseTracking=function(){var _this=this,handleMouseMove=throttle(function(event){if(_this._isActive&&_this._tracker&&!(_this._mouseEvents>=_this._config.maxMouseEvents)){var target=event.target,mouseData={x:event.clientX,y:event.clientY,type:"move",element:target?_this._getElementSelector(target):"document",timestamp:now()};_this._trackEvent("mouse_move",mouseData),_this._mouseEvents++,_this._mouseMovements++,_this._updateActivity()}},this._config.mouseSampleRate);document.addEventListener("mousemove",handleMouseMove,{passive:!0}),this._listeners.push(function(){return document.removeEventListener("mousemove",handleMouseMove)})},BehavioralTracker.prototype._setupVisibilityTracking=function(){var _this=this;"IntersectionObserver"in window&&(this._visibilityObserver=new IntersectionObserver(function(entries){entries.forEach(function(entry){var _a,element=entry.target,isVisible=entry.isIntersecting,timestamp=now();if(isVisible)_this._visibilityTimers.set(element,timestamp);else{var startTime=_this._visibilityTimers.get(element);if(startTime){var duration=timestamp-startTime,visibilityData={element:_this._getElementSelector(element),visible:!1,duration:duration,timestamp:timestamp};_this._trackEvent("element_visibility",visibilityData),_this._visibilityTimers.delete(element),(null===(_a=_this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.log("Element visibility tracked:",visibilityData)}}})},{threshold:[0,.25,.5,.75,1]}),document.querySelectorAll("[data-track-visibility], .cta, .product, .pricing").forEach(function(el){var _a;null===(_a=_this._visibilityObserver)||void 0===_a||_a.observe(el),_this._trackedElements.add(el)}))},BehavioralTracker.prototype._setupPerformanceTracking=function(){var _a,_this=this;if("PerformanceObserver"in window)try{this._performanceObserver=new PerformanceObserver(function(list){list.getEntries().forEach(function(entry){"largest-contentful-paint"===entry.entryType?_this._trackEvent("performance",{metric:"lcp",value:entry.startTime,timestamp:now()}):"first-input"===entry.entryType?_this._trackEvent("performance",{metric:"fid",value:entry.processingStart-entry.startTime,timestamp:now()}):"layout-shift"===entry.entryType&&_this._trackEvent("performance",{metric:"cls",value:entry.value,timestamp:now()})})}),this._performanceObserver.observe({entryTypes:["largest-contentful-paint","first-input","layout-shift"]})}catch(error){(null===(_a=this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.warn("Performance tracking not supported:",error)}},BehavioralTracker.prototype._setupActivityTracking=function(){var _this=this,resetIdleTimer=function(){_this._idleTimer&&clearTimeout(_this._idleTimer),_this._idleTimer=window.setTimeout(function(){_this._trackEvent("user_idle",{duration:3e4,timestamp:now()})},3e4)};["mousedown","mousemove","keypress","scroll","touchstart"].forEach(function(eventType){document.addEventListener(eventType,resetIdleTimer,{passive:!0}),_this._listeners.push(function(){return document.removeEventListener(eventType,resetIdleTimer)})}),resetIdleTimer()},BehavioralTracker.prototype._startEngagementTracking=function(){var _this=this;this._engagementInterval=window.setInterval(function(){if(_this._isActive&&_this._tracker){var metrics=_this._calculateEngagementMetrics();_this._trackEvent("engagement_metrics",metrics),_this._tracker.config.debug&&console.log("Engagement metrics:",metrics)}},3e4)},BehavioralTracker.prototype._calculateEngagementMetrics=function(){var currentTime=now(),timeOnPage=currentTime-this._startTime,idleTime=currentTime-this._lastActivity,scrollWeight=25*Math.min(this._maxScrollDepth/100,1),clickWeight=25*Math.min(this._clickCount/5,1),formWeight=25*Math.min(this._formInteractions/3,1),timeWeight=25*Math.min(timeOnPage/6e4,1),engagementScore=Math.round(scrollWeight+clickWeight+formWeight+timeWeight);return{timeOnPage:timeOnPage,scrollDepth:this._maxScrollDepth,clickCount:this._clickCount,formInteractions:this._formInteractions,mouseMovements:this._mouseMovements,idleTime:idleTime,engagementScore:engagementScore}},BehavioralTracker.prototype._trackEvent=function(type,data){if(this._tracker){var eventData={type:type,element:data.element||type,value:data.value||JSON.stringify(data),timestamp:data.timestamp||now(),sessionId:this._tracker.session.sessionId,visitorId:this._tracker.session.visitorId,metadata:data};this._tracker.track("behavioral:".concat(type),eventData)}},BehavioralTracker.prototype._updateActivity=function(){this._lastActivity=now()},BehavioralTracker.prototype._isExcluded=function(element){return this._config.excludeSelectors.some(function(selector){return element.matches(selector)})},BehavioralTracker.prototype._getElementSelector=function(element){if(!element)return"unknown";if(element.id)return"#".concat(element.id);if(element.className&&"string"==typeof element.className){var classes=element.className.split(" ").filter(function(c){return c.length>0});if(classes.length>0)return".".concat(classes[0])}return element.tagName?element.tagName.toLowerCase():"unknown"},BehavioralTracker.prototype._getElementText=function(element){return(element.textContent||element.value||"").trim().slice(0,100)},BehavioralTracker.prototype.enable=function(){this._isActive=!0},BehavioralTracker.prototype.disable=function(){this._isActive=!1},BehavioralTracker.prototype.destroy=function(){var _a;this._isActive=!1,this._idleTimer&&clearTimeout(this._idleTimer),this._engagementInterval&&clearInterval(this._engagementInterval),this._visibilityObserver&&this._visibilityObserver.disconnect(),this._performanceObserver&&this._performanceObserver.disconnect(),this._listeners.forEach(function(removeListener){return removeListener()}),this._listeners=[],this._trackedElements.clear(),this._visibilityTimers.clear(),(null===(_a=this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.log("BehavioralTracker destroyed")},BehavioralTracker.prototype.getEngagementMetrics=function(){return this._calculateEngagementMetrics()},BehavioralTracker.prototype.trackCustomEvent=function(type,data){this._trackEvent(type,data)},BehavioralTracker}(),EventEmitter=function(){function EventEmitter(){this._events=new Map}return EventEmitter.prototype.on=function(event,callback){this._events.has(event)||this._events.set(event,[]),this._events.get(event).push(callback)},EventEmitter.prototype.off=function(event,callback){var listeners=this._events.get(event);if(listeners){var index=listeners.indexOf(callback);index>-1&&listeners.splice(index,1),0===listeners.length&&this._events.delete(event)}},EventEmitter.prototype.emit=function(event){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];var listeners=this._events.get(event);listeners&&__spreadArray([],listeners,!0).forEach(function(callback){try{callback.apply(void 0,args)}catch(error){"production"!==process.env.NODE_ENV&&console.error("Event listener error:",error)}})},EventEmitter.prototype.once=function(event,callback){var _this=this,onceWrapper=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];callback.apply(void 0,args),_this.off(event,onceWrapper)};this.on(event,onceWrapper)},EventEmitter.prototype.removeAllListeners=function(event){event?this._events.delete(event):this._events.clear()},EventEmitter.prototype.listenerCount=function(event){var listeners=this._events.get(event);return listeners?listeners.length:0},EventEmitter.prototype.eventNames=function(){return Array.from(this._events.keys())},EventEmitter}(),SessionManager=function(){function SessionManager(storage,options){void 0===options&&(options={}),this._currentSession=null,this._fingerprint=null,this._listeners=new Map,this._destroyed=!1,this.SESSION_KEY="session",this.VISITOR_KEY="visitor",this.FINGERPRINT_KEY="fingerprint",this.TABS_KEY="active_tabs",this.HEARTBEAT_KEY="heartbeat",this._storage=storage,this._options=__assign({sessionTimeout:18e5,enableCrossTabs:!0,enableFingerprinting:!0,fingerprintElements:{screen:!0,timezone:!0,language:!0,platform:!0,plugins:!0,canvas:!1},sessionValidation:!0,storagePrefix:"opt_session_"},options),this._tabId=this._generateTabId(),this._options.enableFingerprinting&&this._generateFingerprint(),this._options.enableCrossTabs&&isBrowser()&&(this._setupCrossTabSync(),this._startHeartbeat())}return SessionManager.prototype.initializeSession=function(){return __awaiter(this,void 0,void 0,function(){var restored,newSession,error_1,fallback;return __generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,3,,4]),[4,this._restoreSession()];case 1:return(restored=_a.sent())?(this._currentSession=restored,this._emit("session:restored",restored),[2,restored]):[4,this._createNewSession()];case 2:return newSession=_a.sent(),this._currentSession=newSession,this._saveSession(newSession),this._emit("session:created",newSession),[2,newSession];case 3:return error_1=_a.sent(),console.error("Session initialization failed:",error_1),fallback=this._createBasicSession(),this._currentSession=fallback,[2,fallback];case 4:return[2]}})})},SessionManager.prototype.getCurrentSession=function(){return this._currentSession},SessionManager.prototype.updateActivity=function(){this._currentSession&&(this._currentSession.lastActivity=now(),this._currentSession.pageViews++,this._saveSession(this._currentSession))},SessionManager.prototype.validateSession=function(){return __awaiter(this,void 0,void 0,function(){var reasons,isValid,currentFingerprint,storedFingerprint;return __generator(this,function(_a){switch(_a.label){case 0:return this._currentSession?(reasons=[],isValid=!0,now()-this._currentSession.lastActivity>this._options.sessionTimeout&&(isValid=!1,reasons.push("Session timeout exceeded")),this._options.enableFingerprinting&&this._options.sessionValidation?[4,this._generateFingerprint()]:[3,2]):[2,{isValid:!1,reasons:["No active session"],fingerprint:this._fingerprint,lastValidated:now()}];case 1:currentFingerprint=_a.sent(),(storedFingerprint=this._getStoredFingerprint())&&currentFingerprint.hash!==storedFingerprint.hash&&this._checkCriticalFingerprintMismatch(currentFingerprint,storedFingerprint)&&(isValid=!1,reasons.push("Session fingerprint validation failed")),_a.label=2;case 2:return[2,{isValid:isValid,reasons:reasons,fingerprint:this._fingerprint,lastValidated:now()}]}})})},SessionManager.prototype.invalidateSession=function(){this._currentSession&&(this._emit("session:invalid",this._currentSession),this._currentSession=null,this._storage.remove(this.SESSION_KEY))},SessionManager.prototype.getFingerprint=function(){return this._fingerprint},SessionManager.prototype.on=function(event,callback){this._listeners.has(event)||this._listeners.set(event,[]),this._listeners.get(event).push(callback)},SessionManager.prototype.off=function(event,callback){var listeners=this._listeners.get(event);if(listeners){var index=listeners.indexOf(callback);index>-1&&listeners.splice(index,1)}},SessionManager.prototype.destroy=function(){if(!this._destroyed){this._syncTimer&&clearInterval(this._syncTimer),this._heartbeatTimer&&clearInterval(this._heartbeatTimer);try{this._removeFromActiveTabs()}catch(error){}this._listeners.clear(),this._destroyed=!0}},SessionManager.prototype._restoreSession=function(){return __awaiter(this,void 0,void 0,function(){var sessionData,session;return __generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,3]),(sessionData=this._storage.get(this.SESSION_KEY))&&(session=safeJsonParse(sessionData,null))?[4,this._validateStoredSession(session)]:[2,null];case 1:return _a.sent().isValid?[2,session]:(this._storage.remove(this.SESSION_KEY),[2,null]);case 2:return _a.sent(),[2,null];case 3:return[2]}})})},SessionManager.prototype._createNewSession=function(){return __awaiter(this,void 0,void 0,function(){var visitorId,session;return __generator(this,function(_a){try{visitorId=this._storage.get(this.VISITOR_KEY)||generateVisitorId(),this._storage.set(this.VISITOR_KEY,visitorId)}catch(error){visitorId=generateVisitorId()}session={sessionId:generateSessionId(),visitorId:visitorId,startTime:now(),lastActivity:now(),pageViews:0,platform:detectPlatform(),userAgent:getUserAgent(),referrer:getReferrer(),landingPage:getCurrentUrl()};try{this._addToActiveTabs()}catch(error){}return[2,session]})})},SessionManager.prototype._createBasicSession=function(){return{sessionId:generateSessionId(),visitorId:generateVisitorId(),startTime:now(),lastActivity:now(),pageViews:0,platform:detectPlatform(),userAgent:getUserAgent(),referrer:getReferrer(),landingPage:getCurrentUrl()}},SessionManager.prototype._saveSession=function(session){try{this._storage.set(this.SESSION_KEY,safeJsonStringify(session))}catch(error){this._options.debug&&console.warn("Failed to save session:",error)}},SessionManager.prototype._generateFingerprint=function(){return __awaiter(this,void 0,void 0,function(){var elements,fingerprint,_a,hashString;return __generator(this,function(_b){switch(_b.label){case 0:return isBrowser()?(elements=this._options.fingerprintElements,fingerprint={},elements.screen&&(fingerprint.screenResolution="".concat(screen.width,"x").concat(screen.height)),elements.timezone&&(fingerprint.timezone=(new Date).getTimezoneOffset()),elements.language&&(fingerprint.language=navigator.language||"unknown"),elements.platform&&(fingerprint.platform=detectPlatform(),fingerprint.browser=detectBrowser()),elements.plugins&&(fingerprint.pluginsHash=this._hashPlugins()),elements.canvas?(_a=fingerprint,[4,this._generateCanvasFingerprint()]):[3,2]):(this._fingerprint={screenResolution:"unknown",timezone:0,language:"unknown",platform:"server",browser:"unknown",pluginsHash:"unknown",hash:"server-side"},[2,this._fingerprint]);case 1:_a.canvasHash=_b.sent(),_b.label=2;case 2:return hashString=Object.values(fingerprint).join("|"),fingerprint.hash=this._simpleHash(hashString).toString(),this._fingerprint=fingerprint,this._storage.set(this.FINGERPRINT_KEY,safeJsonStringify(this._fingerprint)),[2,this._fingerprint]}})})},SessionManager.prototype._getStoredFingerprint=function(){var stored=this._storage.get(this.FINGERPRINT_KEY);return stored?safeJsonParse(stored,null):null},SessionManager.prototype._checkCriticalFingerprintMismatch=function(current,stored){return current.platform!==stored.platform||current.browser!==stored.browser||current.screenResolution!==stored.screenResolution},SessionManager.prototype._validateStoredSession=function(session){return __awaiter(this,void 0,void 0,function(){var timeSinceActivity,reasons,isValid;return __generator(this,function(_a){return timeSinceActivity=now()-session.lastActivity,reasons=[],isValid=!0,timeSinceActivity>this._options.sessionTimeout&&(isValid=!1,reasons.push("Session expired")),[2,{isValid:isValid,reasons:reasons,fingerprint:this._fingerprint,lastValidated:now()}]})})},SessionManager.prototype._setupCrossTabSync=function(){var _this=this;isBrowser()&&(window.addEventListener("storage",function(event){event.key===_this._getStorageKey(_this.SESSION_KEY)&&_this._handleSessionSync(event.newValue)}),this._syncTimer=window.setInterval(function(){_this._checkTabSync()},5e3))},SessionManager.prototype._startHeartbeat=function(){var _this=this;isBrowser()&&(this._heartbeatTimer=window.setInterval(function(){_this._updateHeartbeat(),_this._cleanupInactiveTabs()},1e4))},SessionManager.prototype._handleSessionSync=function(newSessionData){var _a;if(newSessionData){var session=safeJsonParse(newSessionData,null);session&&session.sessionId!==(null===(_a=this._currentSession)||void 0===_a?void 0:_a.sessionId)&&(this._currentSession=session,this._emit("session:synchronized",session))}},SessionManager.prototype._checkTabSync=function(){var activeTabs=this._getActiveTabs(),currentTime=now(),thisTab=activeTabs[this._tabId];(!thisTab||currentTime-thisTab.lastHeartbeat>3e4)&&this._addToActiveTabs()},SessionManager.prototype._updateHeartbeat=function(){var _a,heartbeat={tabId:this._tabId,timestamp:now(),sessionId:(null===(_a=this._currentSession)||void 0===_a?void 0:_a.sessionId)||"unknown"};this._storage.set(this.HEARTBEAT_KEY,safeJsonStringify(heartbeat))},SessionManager.prototype._getActiveTabs=function(){try{var stored=this._storage.get(this.TABS_KEY);return stored?safeJsonParse(stored,{}):{}}catch(error){return{}}},SessionManager.prototype._addToActiveTabs=function(){var _a;try{var activeTabs=this._getActiveTabs();activeTabs[this._tabId]={startTime:now(),lastHeartbeat:now(),sessionId:(null===(_a=this._currentSession)||void 0===_a?void 0:_a.sessionId)||"pending"},this._storage.set(this.TABS_KEY,safeJsonStringify(activeTabs))}catch(error){}},SessionManager.prototype._removeFromActiveTabs=function(){try{var activeTabs=this._getActiveTabs();delete activeTabs[this._tabId],this._storage.set(this.TABS_KEY,safeJsonStringify(activeTabs))}catch(error){}},SessionManager.prototype._cleanupInactiveTabs=function(){for(var activeTabs=this._getActiveTabs(),currentTime=now(),hasChanges=!1,_i=0,_a=Object.entries(activeTabs);_i<_a.length;_i++){var _b=_a[_i],tabId=_b[0];currentTime-_b[1].lastHeartbeat>6e4&&(delete activeTabs[tabId],hasChanges=!0)}hasChanges&&this._storage.set(this.TABS_KEY,safeJsonStringify(activeTabs))},SessionManager.prototype._generateTabId=function(){return"tab_"+Math.random().toString(36).substr(2,9)+"_"+now()},SessionManager.prototype._getStorageKey=function(key){return this._options.storagePrefix+key},SessionManager.prototype._hashPlugins=function(){if(!isBrowser()||!navigator.plugins)return"unknown";var plugins=Array.from(navigator.plugins).map(function(plugin){return plugin.name}).sort().join("|");return this._simpleHash(plugins).toString()},SessionManager.prototype._generateCanvasFingerprint=function(){return __awaiter(this,void 0,void 0,function(){var canvas,ctx;return __generator(this,function(_a){if(!isBrowser())return[2,"unknown"];try{return canvas=document.createElement("canvas"),(ctx=canvas.getContext("2d"))?(ctx.textBaseline="top",ctx.font="14px Arial",ctx.fillText("Fingerprint test ðŸŽ¨",2,2),[2,this._simpleHash(canvas.toDataURL()).toString()]):[2,"unknown"]}catch(_b){return[2,"canvas-blocked"]}return[2]})})},SessionManager.prototype._simpleHash=function(str){for(var hash=0,i=0;i<str.length;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash;return Math.abs(hash)},SessionManager.prototype._emit=function(type,session){var event={type:type,session:session,timestamp:now(),tabId:this._tabId};(this._listeners.get(type)||[]).forEach(function(callback){try{callback(event)}catch(error){console.error("Session event listener error:",error)}})},SessionManager}(),Storage=function(){function Storage(prefix){void 0===prefix&&(prefix="opt_"),this._fallback=new Map,this._prefix=prefix}return Storage.prototype.get=function(key){var prefixedKey=this._prefix+key;try{if(isBrowser()&&window.localStorage&&null!==(value=localStorage.getItem(prefixedKey))){if((parsed=safeJsonParse(value,null))&&this._isNotExpired(parsed.expiry))return parsed.value;parsed&&localStorage.removeItem(prefixedKey)}}catch(e){}try{var value,parsed;if(isBrowser()&&window.sessionStorage&&null!==(value=sessionStorage.getItem(prefixedKey))&&(parsed=safeJsonParse(value,null))&&this._isNotExpired(parsed.expiry))return parsed.value}catch(e){}try{if(isBrowser()){var cookieValue=this._getCookie(prefixedKey);if(cookieValue)return cookieValue}}catch(e){}return this._fallback.get(prefixedKey)||null},Storage.prototype.set=function(key,value,expiry){var _this=this,prefixedKey=this._prefix+key,storageValue=safeJsonStringify({value:value,expiry:expiry});try{if(isBrowser()&&window.localStorage)return void localStorage.setItem(prefixedKey,storageValue)}catch(e){}try{if(isBrowser()&&window.sessionStorage)return void sessionStorage.setItem(prefixedKey,storageValue)}catch(e){}try{if(isBrowser()&&value.length<4e3)return void this._setCookie(prefixedKey,value,expiry)}catch(e){}this._fallback.set(prefixedKey,value),this._fallback.size>100&&Array.from(this._fallback.entries()).slice(0,20).forEach(function(_a){var k=_a[0];return _this._fallback.delete(k)})},Storage.prototype.remove=function(key){var prefixedKey=this._prefix+key;try{isBrowser()&&window.localStorage&&localStorage.removeItem(prefixedKey)}catch(e){}try{isBrowser()&&window.sessionStorage&&sessionStorage.removeItem(prefixedKey)}catch(e){}try{isBrowser()&&this._deleteCookie(prefixedKey)}catch(e){}this._fallback.delete(prefixedKey)},Storage.prototype.clear=function(){var _this=this;this._getAllKeys().forEach(function(key){return _this.remove(key.replace(_this._prefix,""))}),this._fallback.clear()},Storage.prototype._isNotExpired=function(expiry){return!expiry||Date.now()<expiry},Storage.prototype._getAllKeys=function(){var _this=this,keys=[];try{if(isBrowser()&&window.localStorage)for(var i=0;i<localStorage.length;i++)(key=localStorage.key(i))&&key.startsWith(this._prefix)&&keys.push(key)}catch(e){}try{if(isBrowser()&&window.sessionStorage)for(i=0;i<sessionStorage.length;i++){var key;(key=sessionStorage.key(i))&&key.startsWith(this._prefix)&&keys.push(key)}}catch(e){}return this._fallback.forEach(function(_,key){key.startsWith(_this._prefix)&&keys.push(key)}),Array.from(new Set(keys))},Storage.prototype._getCookie=function(name){var _a;if(!isBrowser())return null;var parts="; ".concat(document.cookie).split("; ".concat(name,"="));if(2===parts.length){var cookieValue=null===(_a=parts.pop())||void 0===_a?void 0:_a.split(";").shift();return cookieValue?decodeURIComponent(cookieValue):null}return null},Storage.prototype._setCookie=function(name,value,expiry){if(isBrowser()){var cookieString="".concat(name,"=").concat(encodeURIComponent(value),"; path=/");if(expiry){var expiryDate=new Date(expiry);cookieString+="; expires=".concat(expiryDate.toUTCString())}"https:"===location.protocol&&(cookieString+="; secure"),cookieString+="; samesite=lax",document.cookie=cookieString}},Storage.prototype._deleteCookie=function(name){isBrowser()&&(document.cookie="".concat(name,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"))},Storage}(),Tracker=function(_super){function Tracker(){var _this=_super.call(this)||this;return _this.isInitialized=!1,_this._modules=new Map,_this._eventQueue=[],_this._destroyed=!1,_this._storage=new Storage,_this._sessionManager=new SessionManager(_this._storage),_this.config={apiUrl:"",projectId:"",debug:!1,enableGDPR:!0,sessionTimeout:18e5,batchSize:10,flushInterval:5e3,platform:"auto"},_this.session=_this._createEmptySession(),_this}return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}(Tracker,_super),Tracker.prototype.init=function(config){return __awaiter(this,void 0,void 0,function(){var sessionOptions,_a,behavioralTracker,_this=this;return __generator(this,function(_b){switch(_b.label){case 0:if(this.isInitialized)return this.config.debug&&console.warn("Tracker already initialized"),[2];if(this.config=deepMerge(this.config,config),!this.config.apiUrl||!this.config.projectId)throw new Error("apiUrl and projectId are required");return this._storage=new Storage("opt_".concat(this.config.projectId,"_")),sessionOptions={sessionTimeout:this.config.sessionTimeout||18e5,enableCrossTabs:!0,enableFingerprinting:!0,sessionValidation:!0,storagePrefix:"opt_".concat(this.config.projectId,"_session_")},this._sessionManager=new SessionManager(this._storage,sessionOptions),this._sessionManager.on("session:created",function(event){_this.session=event.session,_this.emit("session:created",event),_this.config.debug&&console.log("New session created:",event)}),this._sessionManager.on("session:restored",function(event){_this.session=event.session,_this.emit("session:restored",event),_this.config.debug&&console.log("Session restored:",event)}),this._sessionManager.on("session:synchronized",function(event){_this.session=event.session,_this.emit("session:synchronized",event),_this.config.debug&&console.log("Session synchronized across tabs:",event)}),this._sessionManager.on("session:invalid",function(event){_this.emit("session:invalid",event),_this.config.debug&&console.log("Session invalidated:",event)}),_a=this,[4,this._sessionManager.initializeSession()];case 1:return _a.session=_b.sent(),(behavioralTracker=new BehavioralTracker({enableClickTracking:!0,enableScrollTracking:!0,enableFormTracking:!0,enableMouseTracking:!!this.config.debug,enableVisibilityTracking:!0,enablePerformanceTracking:!0})).setTracker(this),this.use(behavioralTracker),this._startFlushTimer(),isBrowser()&&domReady(function(){_this.pageView()}),this.isInitialized=!0,this.emit("initialized",this.config),this.config.debug&&console.log("Tracker initialized",{config:this.config,session:this.session,fingerprint:this._sessionManager.getFingerprint(),modules:Array.from(this._modules.keys())}),[2]}})})},Tracker.prototype.track=function(event,data){if(void 0===data&&(data={}),this.isInitialized)if(this.hasConsent()){var eventData={type:"custom",element:event,value:data,timestamp:now(),sessionId:this.session.sessionId,visitorId:this.session.visitorId,metadata:data};this._queueEvent(eventData),this.emit("track",eventData),this.config.debug&&console.log("Event tracked",eventData)}else this.config.debug&&console.warn("No consent for tracking");else this.config.debug&&console.warn("Tracker not initialized")},Tracker.prototype.identify=function(visitorId,traits){void 0===traits&&(traits={}),this.isInitialized&&(this.session.visitorId=visitorId,this.track("identify",{visitorId:visitorId,traits:traits}),this.emit("identify",{visitorId:visitorId,traits:traits}))},Tracker.prototype.pageView=function(data){if(void 0===data&&(data={}),this.isInitialized&&this.hasConsent()){var pageViewData=__assign({url:getCurrentUrl(),title:getCurrentTitle(),timestamp:now(),sessionId:this.session.sessionId,visitorId:this.session.visitorId,referrer:getReferrer()},data);this._sessionManager.updateActivity(),this.session=this._sessionManager.getCurrentSession()||this.session,this._queueEvent({type:"pageview",element:pageViewData.url,value:pageViewData.title,timestamp:pageViewData.timestamp,sessionId:pageViewData.sessionId,visitorId:pageViewData.visitorId,metadata:pageViewData}),this.emit("pageview",pageViewData),this.config.debug&&console.log("Page view tracked",pageViewData)}},Tracker.prototype.use=function(module){this._modules.has(module.name)?this.config.debug&&console.warn("Module ".concat(module.name," already registered")):(this._modules.set(module.name,module),this.isInitialized&&module.init(),this.emit("module:added",module))},Tracker.prototype.getModule=function(name){return this._modules.get(name)||null},Tracker.prototype.setConsent=function(consent){this._storage.set("consent",JSON.stringify(consent)),this.emit("consent:changed",consent),this.config.debug&&console.log("Consent updated",consent)},Tracker.prototype.hasConsent=function(){if(!this.config.enableGDPR)return!0;var consentData=this._storage.get("consent");if(!consentData)return!1;try{var consent=JSON.parse(consentData);return consent.hasConsent&&consent.purposes.analytics}catch(_a){return!1}},Tracker.prototype.flush=function(){return __awaiter(this,void 0,void 0,function(){var events,error_1,_a;return __generator(this,function(_b){switch(_b.label){case 0:if(0===this._eventQueue.length)return[2];events=__spreadArray([],this._eventQueue,!0),this._eventQueue=[],_b.label=1;case 1:return _b.trys.push([1,3,,4]),[4,this._sendEvents(events)];case 2:return _b.sent(),this.emit("events:sent",events),[3,4];case 3:return error_1=_b.sent(),(_a=this._eventQueue).unshift.apply(_a,events),this.emit("events:failed",error_1),this.config.debug&&console.error("Failed to send events",error_1),[3,4];case 4:return[2]}})})},Tracker.prototype.destroy=function(){this._destroyed||(this._flushTimer&&clearInterval(this._flushTimer),this.flush().catch(function(){}),this._sessionManager.destroy(),this._modules.forEach(function(module){module.destroy&&module.destroy()}),this._modules.clear(),this.removeAllListeners(),this._destroyed=!0,this.isInitialized=!1)},Tracker.prototype._createEmptySession=function(){return{sessionId:"",visitorId:"",startTime:0,lastActivity:0,pageViews:0,platform:"",userAgent:"",landingPage:""}},Tracker.prototype._queueEvent=function(event){this._eventQueue.push(event),this._eventQueue.length>=this.config.batchSize&&this.flush().catch(function(){})},Tracker.prototype._startFlushTimer=function(){var _this=this;this._flushTimer&&clearInterval(this._flushTimer),this._flushTimer=window.setInterval(function(){_this._eventQueue.length>0&&_this.flush().catch(function(){})},this.config.flushInterval)},Tracker.prototype._sendEvents=function(events){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.config.debug&&console.log("Sending events",events),[4,new Promise(function(resolve){return setTimeout(resolve,100)})];case 1:return _a.sent(),[2]}})})},Tracker}(EventEmitter),globalTracker=null;function init(config){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return globalTracker||(globalTracker=new Tracker),[4,globalTracker.init(config)];case 1:return _a.sent(),[2,globalTracker]}})})}function getTracker(){return globalTracker}function track(event,data){globalTracker&&globalTracker.track(event,data)}function pageView(data){globalTracker&&globalTracker.pageView(data)}function identify(visitorId,traits){globalTracker&&globalTracker.identify(visitorId,traits)}function setConsent(consent){globalTracker&&globalTracker.setConsent(consent)}function createTracker(config){var tracker=new Tracker;return config&&config.apiUrl&&config.projectId&&tracker.init(config).catch(function(error){config.debug&&console.error("Failed to initialize tracker:",error)}),tracker}if(isBrowser()){var globalWindow=window;globalWindow.optimizelyConfig&&init(globalWindow.optimizelyConfig),globalWindow.Optimizely={init:init,getTracker:getTracker,track:track,pageView:pageView,identify:identify,setConsent:setConsent,createTracker:createTracker,Tracker:Tracker}}var index={init:init,getTracker:getTracker,track:track,pageView:pageView,identify:identify,setConsent:setConsent,createTracker:createTracker,Tracker:Tracker};export{BehavioralTracker,EventEmitter,SessionManager,Storage,Tracker,addEventListener,createTracker,debounce,deepMerge,index as default,detectBrowser,detectPlatform,domReady,generateSessionId,generateVisitorId,getCurrentTitle,getCurrentUrl,getReferrer,getScrollDepth,getTracker,getUserAgent,identify,init,isBrowser,isElementVisible,isProduction,now,pageView,safeJsonParse,safeJsonStringify,setConsent,simpleHash,throttle,track};
//# sourceMappingURL=tracker.esm.js.map

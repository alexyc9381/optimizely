var extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])},extendStatics(d,b)};function __extends(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}var __assign=function(){return __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)};function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}function __generator(thisArg,body){var f,y,t,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]},g=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return g.next=verb(0),g.throw=verb(1),g.return=verb(2),"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;g&&(g=0,op[0]&&(_=0)),_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!((t=(t=_.trys).length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __spreadArray(to,from,pack){if(pack||2===arguments.length)for(var ar,i=0,l=from.length;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))}function generateVisitorId(){return"v_"+generateRandomId(16)}function generateSessionId(){return"s_"+generateRandomId(12)+"_"+Date.now()}function generateRandomId(length){for(var result="",i=0;i<length;i++)result+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return result}function generateId(){return Math.random().toString(36).substr(2,9)+Date.now().toString(36)}function now(){return Date.now()}function debounce(func,wait){var timeout=null;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var context=this;timeout&&clearTimeout(timeout),timeout=setTimeout(function(){func.apply(context,args)},wait)}}function throttle(func,limit){var inThrottle=!1;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];inThrottle||(func.apply(this,args),inThrottle=!0,setTimeout(function(){return inThrottle=!1},limit))}}function isBrowser(){return"undefined"!=typeof window&&"undefined"!=typeof document}function isProduction(){return"production"===process.env.NODE_ENV}function safeJsonParse(json,fallback){void 0===fallback&&(fallback=null);try{return JSON.parse(json)}catch(_a){return fallback}}function safeJsonStringify(obj,fallback){void 0===fallback&&(fallback="{}");try{return JSON.stringify(obj)}catch(_a){return fallback}}function getCurrentUrl(){return isBrowser()?window.location.href.split("#")[0].split("?")[0]:""}function getCurrentTitle(){return isBrowser()&&document.title||""}function getReferrer(){return isBrowser()&&document.referrer||""}function getUserAgent(){return isBrowser()?navigator.userAgent||"":"server"}function detectPlatform(){if(!isBrowser())return"server";var userAgent=getUserAgent().toLowerCase();return/android/.test(userAgent)?"android":/iphone|ipad|ipod/.test(userAgent)?"ios":/windows/.test(userAgent)?"windows":/mac/.test(userAgent)?"mac":/linux/.test(userAgent)?"linux":"unknown"}function detectBrowser(){if(!isBrowser())return"unknown";var userAgent=getUserAgent().toLowerCase();return/chrome/.test(userAgent)&&!/edge/.test(userAgent)?"chrome":/firefox/.test(userAgent)?"firefox":/safari/.test(userAgent)&&!/chrome/.test(userAgent)?"safari":/edge/.test(userAgent)?"edge":/opera/.test(userAgent)?"opera":"unknown"}function isElementVisible(element){if(!isBrowser())return!1;var rect=element.getBoundingClientRect(),windowHeight=window.innerHeight||document.documentElement.clientHeight,windowWidth=window.innerWidth||document.documentElement.clientWidth;return rect.top>=0&&rect.left>=0&&rect.bottom<=windowHeight&&rect.right<=windowWidth}function getScrollDepth(){if(!isBrowser())return 0;var scrollTop=window.pageYOffset||document.documentElement.scrollTop,documentHeight=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),windowHeight=window.innerHeight||document.documentElement.clientHeight;return documentHeight<=windowHeight?100:Math.round((scrollTop+windowHeight)/documentHeight*100)}function domReady(callback){isBrowser()&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",callback):callback()}function addEventListener(element,event,handler,options){return element.addEventListener(event,handler,options),function(){return element.removeEventListener(event,handler,options)}}function simpleHash(str){var hash=0;if(0===str.length)return hash;for(var i=0;i<str.length;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash;return Math.abs(hash)}function deepMerge(target,source){var result=__assign({},target);for(var key in source)source.hasOwnProperty(key)&&(source[key]&&"object"==typeof source[key]&&!Array.isArray(source[key])?result[key]=deepMerge(result[key]||{},source[key]):result[key]=source[key]);return result}function getPlatform(){return isBrowser()?navigator.platform:"server"}function getLanguage(){return isBrowser()&&(navigator.language||navigator.userLanguage)||"en"}function getTimezoneOffset(){return isBrowser()?(new Date).getTimezoneOffset():0}function shouldAnonymizeIP(ip,settings){return settings.anonymizeIPs&&Boolean(ip)&&"127.0.0.1"!==ip&&"::1"!==ip}function anonymizeIPv4(ip){var parts=ip.split(".");return 4===parts.length?"".concat(parts[0],".").concat(parts[1],".").concat(parts[2],".0"):ip}function anonymizeIPv6(ip){var parts=ip.split(":");return parts.length>=4?"".concat(parts.slice(0,4).join(":"),"::"):ip}function anonymizeIP(ip){return ip?ip.includes(":")?anonymizeIPv6(ip):anonymizeIPv4(ip):ip}function shouldMinimizeData(settings){return settings.dataMinimization}function removePII(data){if(!data||"object"!=typeof data)return data;var cleaned=__assign({},data);return["email","phone","name","firstName","lastName","fullName","address","street","city","zipCode","postalCode","ssn","socialSecurityNumber","creditCard","bankAccount","passport","driverLicense","taxId"].forEach(function(field){cleaned[field]&&delete cleaned[field]}),cleaned}function hashSensitiveData(data){if(!data)return data;for(var hash=0,i=0;i<data.length;i++)hash=(hash<<5)-hash+data.charCodeAt(i),hash&=hash;return Math.abs(hash).toString(36)}function isConsentRequired(){if(!isBrowser())return!0;var timezone=Intl.DateTimeFormat().resolvedOptions().timeZone;return["Europe/","Atlantic/Azores","Atlantic/Madeira","Atlantic/Canary"].some(function(tz){return timezone.startsWith(tz)})}function getDoNotTrackStatus(){return!!isBrowser()&&("1"===navigator.doNotTrack||"1"===window.doNotTrack||"1"===navigator.msDoNotTrack)}function areCookiesEnabled(){if(!isBrowser())return!1;try{document.cookie="test_cookie=1";var enabled=-1!==document.cookie.indexOf("test_cookie=");return document.cookie="test_cookie=1; expires=Thu, 01-Jan-1970 00:00:01 GMT",enabled}catch(_a){return!1}}function clearAllCookies(domain){isBrowser()&&document.cookie.split(";").forEach(function(cookie){var eqPos=cookie.indexOf("="),name=eqPos>-1?cookie.substr(0,eqPos).trim():cookie.trim();if(name){document.cookie="".concat(name,"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/"),domain&&(document.cookie="".concat(name,"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=").concat(domain));var hostname=window.location.hostname;if(hostname.includes(".")){var parentDomain="."+hostname.split(".").slice(-2).join(".");document.cookie="".concat(name,"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=").concat(parentDomain)}}})}function isValidEmail(email){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)}function formatGDPRDate(timestamp){return new Date(timestamp).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function calculateRetentionExpiry(timestamp,retentionDays){return timestamp+24*retentionDays*60*60*1e3}function isDataExpired(timestamp,retentionDays){var expiry=calculateRetentionExpiry(timestamp,retentionDays);return now()>expiry}"function"==typeof SuppressedError&&SuppressedError;var BehavioralTracker=function(){function BehavioralTracker(config){void 0===config&&(config={}),this.name="behavioral",this._tracker=null,this._isActive=!1,this._startTime=0,this._lastActivity=0,this._scrollEvents=0,this._mouseEvents=0,this._maxScrollDepth=0,this._clickCount=0,this._formInteractions=0,this._mouseMovements=0,this._trackedElements=new Set,this._visibilityTimers=new Map,this._listeners=[],this._lastScrollTime=0,this._config=__assign({enableClickTracking:!0,enableScrollTracking:!0,enableFormTracking:!0,enableMouseTracking:!0,enableVisibilityTracking:!0,enablePerformanceTracking:!0,scrollThreshold:25,mouseSampleRate:100,clickSelector:'a, button, [role="button"], input[type="submit"], input[type="button"]',formSelector:"form, input, textarea, select",excludeSelectors:[".tracking-ignore",'[data-tracking="false"]'],maxScrollEvents:100,maxMouseEvents:500},config)}return BehavioralTracker.prototype.init=function(){var _a;isBrowser()&&(this._isActive=!0,this._startTime=now(),this._lastActivity=now(),this._setupEventListeners(),this._startEngagementTracking(),(null===(_a=this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.log("BehavioralTracker initialized",this._config))},BehavioralTracker.prototype.setTracker=function(tracker){this._tracker=tracker},BehavioralTracker.prototype._setupEventListeners=function(){this._config.enableClickTracking&&this._setupClickTracking(),this._config.enableScrollTracking&&this._setupScrollTracking(),this._config.enableFormTracking&&this._setupFormTracking(),this._config.enableMouseTracking&&this._setupMouseTracking(),this._config.enableVisibilityTracking&&this._setupVisibilityTracking(),this._config.enablePerformanceTracking&&this._setupPerformanceTracking(),this._setupActivityTracking()},BehavioralTracker.prototype._setupClickTracking=function(){var _this=this,handleClick=function(event){if(_this._isActive&&_this._tracker){var target=event.target;if(target&&!_this._isExcluded(target)){if(!target.matches(_this._config.clickSelector)){for(var parent_1=target.parentElement,found=!1,i=0;i<3&&parent_1;i++){if(parent_1.matches(_this._config.clickSelector)){found=!0;break}parent_1=parent_1.parentElement}if(!found)return}var clickData={element:_this._getElementSelector(target),tagName:target.tagName.toLowerCase(),className:target.className,id:target.id||"",text:_this._getElementText(target),x:event.clientX,y:event.clientY,timestamp:now()};_this._trackEvent("click",clickData),_this._clickCount++,_this._updateActivity(),_this._tracker.config.debug&&console.log("Click tracked:",clickData)}}};document.addEventListener("click",handleClick,{passive:!0}),this._listeners.push(function(){return document.removeEventListener("click",handleClick)})},BehavioralTracker.prototype._setupScrollTracking=function(){var _this=this,lastScrollTop=0,handleScroll=throttle(function(){if(_this._isActive&&_this._tracker&&!(_this._scrollEvents>=_this._config.maxScrollEvents)){var scrollTop=window.pageYOffset||document.documentElement.scrollTop,scrollHeight=document.documentElement.scrollHeight-window.innerHeight,currentDepth=Math.round(scrollTop/scrollHeight*100);if(_this._maxScrollDepth=Math.max(_this._maxScrollDepth,currentDepth),Math.abs(currentDepth-Math.round(lastScrollTop/scrollHeight*100))<_this._config.scrollThreshold)lastScrollTop=scrollTop;else{var currentTime=now(),direction=scrollTop>lastScrollTop?"down":"up",speed=Math.abs(scrollTop-lastScrollTop)/(currentTime-_this._lastScrollTime),scrollData={depth:currentDepth,maxDepth:_this._maxScrollDepth,direction:direction,speed:speed,timestamp:currentTime};_this._trackEvent("scroll",scrollData),_this._scrollEvents++,_this._updateActivity(),lastScrollTop=scrollTop,_this._lastScrollTime=currentTime,_this._tracker.config.debug&&console.log("Scroll tracked:",scrollData)}}},250);window.addEventListener("scroll",handleScroll,{passive:!0}),this._listeners.push(function(){return window.removeEventListener("scroll",handleScroll)})},BehavioralTracker.prototype._setupFormTracking=function(){var _this=this,handleFormEvent=function(event,action){var _a;if(_this._isActive&&_this._tracker){var target=event.target;if(target&&!_this._isExcluded(target)){var form=target.closest("form"),formData={formId:(null==form?void 0:form.id)||"",formName:(null==form?void 0:form.getAttribute("name"))||"",field:_this._getElementSelector(target),fieldType:target.type||target.tagName.toLowerCase(),action:action,value:"change"===action?null===(_a=target.value)||void 0===_a?void 0:_a.slice(0,50):void 0,timestamp:now()};_this._trackEvent("form_interaction",formData),_this._formInteractions++,_this._updateActivity(),_this._tracker.config.debug&&console.log("Form interaction tracked:",formData)}}};["focus","blur","change"].forEach(function(eventType){var handler=function(event){return handleFormEvent(event,eventType)};document.addEventListener(eventType,handler,{passive:!0}),_this._listeners.push(function(){return document.removeEventListener(eventType,handler)})});var handleSubmit=function(event){return handleFormEvent(event,"submit")};document.addEventListener("submit",handleSubmit,{passive:!0}),this._listeners.push(function(){return document.removeEventListener("submit",handleSubmit)})},BehavioralTracker.prototype._setupMouseTracking=function(){var _this=this,handleMouseMove=throttle(function(event){if(_this._isActive&&_this._tracker&&!(_this._mouseEvents>=_this._config.maxMouseEvents)){var target=event.target,mouseData={x:event.clientX,y:event.clientY,type:"move",element:target?_this._getElementSelector(target):"document",timestamp:now()};_this._trackEvent("mouse_move",mouseData),_this._mouseEvents++,_this._mouseMovements++,_this._updateActivity()}},this._config.mouseSampleRate);document.addEventListener("mousemove",handleMouseMove,{passive:!0}),this._listeners.push(function(){return document.removeEventListener("mousemove",handleMouseMove)})},BehavioralTracker.prototype._setupVisibilityTracking=function(){var _this=this;"IntersectionObserver"in window&&(this._visibilityObserver=new IntersectionObserver(function(entries){entries.forEach(function(entry){var _a,element=entry.target,isVisible=entry.isIntersecting,timestamp=now();if(isVisible)_this._visibilityTimers.set(element,timestamp);else{var startTime=_this._visibilityTimers.get(element);if(startTime){var duration=timestamp-startTime,visibilityData={element:_this._getElementSelector(element),visible:!1,duration:duration,timestamp:timestamp};_this._trackEvent("element_visibility",visibilityData),_this._visibilityTimers.delete(element),(null===(_a=_this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.log("Element visibility tracked:",visibilityData)}}})},{threshold:[0,.25,.5,.75,1]}),document.querySelectorAll("[data-track-visibility], .cta, .product, .pricing").forEach(function(el){var _a;null===(_a=_this._visibilityObserver)||void 0===_a||_a.observe(el),_this._trackedElements.add(el)}))},BehavioralTracker.prototype._setupPerformanceTracking=function(){var _a,_this=this;if("PerformanceObserver"in window)try{this._performanceObserver=new PerformanceObserver(function(list){list.getEntries().forEach(function(entry){"largest-contentful-paint"===entry.entryType?_this._trackEvent("performance",{metric:"lcp",value:entry.startTime,timestamp:now()}):"first-input"===entry.entryType?_this._trackEvent("performance",{metric:"fid",value:entry.processingStart-entry.startTime,timestamp:now()}):"layout-shift"===entry.entryType&&_this._trackEvent("performance",{metric:"cls",value:entry.value,timestamp:now()})})}),this._performanceObserver.observe({entryTypes:["largest-contentful-paint","first-input","layout-shift"]})}catch(error){(null===(_a=this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.warn("Performance tracking not supported:",error)}},BehavioralTracker.prototype._setupActivityTracking=function(){var _this=this,resetIdleTimer=function(){_this._idleTimer&&clearTimeout(_this._idleTimer),_this._idleTimer=window.setTimeout(function(){_this._trackEvent("user_idle",{duration:3e4,timestamp:now()})},3e4)};["mousedown","mousemove","keypress","scroll","touchstart"].forEach(function(eventType){document.addEventListener(eventType,resetIdleTimer,{passive:!0}),_this._listeners.push(function(){return document.removeEventListener(eventType,resetIdleTimer)})}),resetIdleTimer()},BehavioralTracker.prototype._startEngagementTracking=function(){var _this=this;this._engagementInterval=window.setInterval(function(){if(_this._isActive&&_this._tracker){var metrics=_this._calculateEngagementMetrics();_this._trackEvent("engagement_metrics",metrics),_this._tracker.config.debug&&console.log("Engagement metrics:",metrics)}},3e4)},BehavioralTracker.prototype._calculateEngagementMetrics=function(){var currentTime=now(),timeOnPage=currentTime-this._startTime,idleTime=currentTime-this._lastActivity,scrollWeight=25*Math.min(this._maxScrollDepth/100,1),clickWeight=25*Math.min(this._clickCount/5,1),formWeight=25*Math.min(this._formInteractions/3,1),timeWeight=25*Math.min(timeOnPage/6e4,1),engagementScore=Math.round(scrollWeight+clickWeight+formWeight+timeWeight);return{timeOnPage:timeOnPage,scrollDepth:this._maxScrollDepth,clickCount:this._clickCount,formInteractions:this._formInteractions,mouseMovements:this._mouseMovements,idleTime:idleTime,engagementScore:engagementScore}},BehavioralTracker.prototype._trackEvent=function(type,data){if(this._tracker){var eventData={type:type,element:data.element||type,value:data.value||JSON.stringify(data),timestamp:data.timestamp||now(),sessionId:this._tracker.session.sessionId,visitorId:this._tracker.session.visitorId,metadata:data};this._tracker.track("behavioral:".concat(type),eventData)}},BehavioralTracker.prototype._updateActivity=function(){this._lastActivity=now()},BehavioralTracker.prototype._isExcluded=function(element){return this._config.excludeSelectors.some(function(selector){return element.matches(selector)})},BehavioralTracker.prototype._getElementSelector=function(element){if(!element)return"unknown";if(element.id)return"#".concat(element.id);if(element.className&&"string"==typeof element.className){var classes=element.className.split(" ").filter(function(c){return c.length>0});if(classes.length>0)return".".concat(classes[0])}return element.tagName?element.tagName.toLowerCase():"unknown"},BehavioralTracker.prototype._getElementText=function(element){return(element.textContent||element.value||"").trim().slice(0,100)},BehavioralTracker.prototype.enable=function(){this._isActive=!0},BehavioralTracker.prototype.disable=function(){this._isActive=!1},BehavioralTracker.prototype.destroy=function(){var _a;this._isActive=!1,this._idleTimer&&clearTimeout(this._idleTimer),this._engagementInterval&&clearInterval(this._engagementInterval),this._visibilityObserver&&this._visibilityObserver.disconnect(),this._performanceObserver&&this._performanceObserver.disconnect(),this._listeners.forEach(function(removeListener){return removeListener()}),this._listeners=[],this._trackedElements.clear(),this._visibilityTimers.clear(),(null===(_a=this._tracker)||void 0===_a?void 0:_a.config.debug)&&console.log("BehavioralTracker destroyed")},BehavioralTracker.prototype.getEngagementMetrics=function(){return this._calculateEngagementMetrics()},BehavioralTracker.prototype.trackCustomEvent=function(type,data){this._trackEvent(type,data)},BehavioralTracker}(),TechnologyDetector=function(){function TechnologyDetector(){this.name="TechnologyDetector",this._isEnabled=!1,this._detectionCache=new Map,this._signatures=[],this._initializeSignatures()}return TechnologyDetector.prototype.init=function(){isBrowser()&&(this._isEnabled=!0,this._performDetection())},TechnologyDetector.prototype.enable=function(){this._isEnabled=!0},TechnologyDetector.prototype.disable=function(){this._isEnabled=!1},TechnologyDetector.prototype.destroy=function(){this._isEnabled=!1,this._detectionCache.clear()},TechnologyDetector.prototype.getCurrentTechStack=function(){return this._detectionCache.get(window.location.hostname)||this._performDetection()},TechnologyDetector.prototype.redetect=function(){return this._detectionCache.delete(window.location.hostname),this._performDetection()},TechnologyDetector.prototype._performDetection=function(){var _a,_b,_c,_d;if(!isBrowser()||!this._isEnabled)return{};for(var detected={analytics:[],libraries:[]},_i=0,_e=this._signatures;_i<_e.length;_i++){var signature=_e[_i];if(this._checkSignature(signature)>.5)switch(signature.category){case"cms":detected.cms=signature.name;break;case"framework":detected.framework=signature.name;break;case"analytics":(null===(_a=detected.analytics)||void 0===_a?void 0:_a.includes(signature.name))||null===(_b=detected.analytics)||void 0===_b||_b.push(signature.name);break;case"library":(null===(_c=detected.libraries)||void 0===_c?void 0:_c.includes(signature.name))||null===(_d=detected.libraries)||void 0===_d||_d.push(signature.name);break;case"server":detected.server=signature.name;break;case"hosting":detected.hosting=signature.name}}return this._detectionCache.set(window.location.hostname,detected),detected},TechnologyDetector.prototype._checkSignature=function(signature){var confidence=0,totalChecks=0,passedChecks=0;if(signature.checks.dom){totalChecks+=signature.checks.dom.length;for(var _i=0,_a=signature.checks.dom;_i<_a.length;_i++){var selector=_a[_i];document.querySelector(selector)&&passedChecks++}}if(signature.checks.js){totalChecks+=signature.checks.js.length;for(var _b=0,_c=signature.checks.js;_b<_c.length;_b++){var jsPath=_c[_b];this._checkJavaScriptObject(jsPath)&&passedChecks++}}if(signature.checks.meta){totalChecks+=signature.checks.meta.length;for(var _d=0,_e=signature.checks.meta;_d<_e.length;_d++){var metaPattern=_e[_d];this._checkMetaTag(metaPattern)&&passedChecks++}}if(signature.checks.text){totalChecks+=signature.checks.text.length;for(var _f=0,_g=signature.checks.text;_f<_g.length;_f++){var textPattern=_g[_f];document.documentElement.outerHTML.includes(textPattern)&&passedChecks++}}if(signature.checks.url){totalChecks+=signature.checks.url.length;for(var _h=0,_j=signature.checks.url;_h<_j.length;_h++){var urlPattern=_j[_h];this._checkUrlPattern(urlPattern)&&passedChecks++}}if(signature.checks.cookies){totalChecks+=signature.checks.cookies.length;for(var _k=0,_l=signature.checks.cookies;_k<_l.length;_k++){var cookiePattern=_l[_k];this._checkCookie(cookiePattern)&&passedChecks++}}return totalChecks>0&&(confidence=passedChecks/totalChecks*signature.confidence),confidence},TechnologyDetector.prototype._checkJavaScriptObject=function(path){try{for(var parts=path.split("."),current=window,_i=0,parts_1=parts;_i<parts_1.length;_i++){var part=parts_1[_i];if(!current||"object"!=typeof current||!(part in current))return!1;current=current[part]}return void 0!==current}catch(_a){return!1}},TechnologyDetector.prototype._checkMetaTag=function(pattern){for(var _i=0,metaTags_1=Array.from(document.querySelectorAll("meta"));_i<metaTags_1.length;_i++){var meta=metaTags_1[_i],name_1=meta.getAttribute("name")||meta.getAttribute("property")||"",content=meta.getAttribute("content")||"";if(name_1.includes(pattern)||content.includes(pattern))return!0}return!1},TechnologyDetector.prototype._checkUrlPattern=function(pattern){for(var _i=0,scripts_1=Array.from(document.querySelectorAll("script[src]"));_i<scripts_1.length;_i++)if((scripts_1[_i].getAttribute("src")||"").includes(pattern))return!0;for(var _a=0,links_1=Array.from(document.querySelectorAll("link[href]"));_a<links_1.length;_a++)if((links_1[_a].getAttribute("href")||"").includes(pattern))return!0;return!1},TechnologyDetector.prototype._checkCookie=function(pattern){return document.cookie.includes(pattern)},TechnologyDetector.prototype._initializeSignatures=function(){this._signatures=[{name:"WordPress",category:"cms",confidence:1,checks:{meta:["generator"],text:["wp-content","wp-includes"],js:["wp"]}},{name:"Shopify",category:"cms",confidence:1,checks:{js:["Shopify"],text:["shopify"],meta:["shopify"]}},{name:"Drupal",category:"cms",confidence:1,checks:{meta:["generator"],text:["/sites/default/","Drupal.settings"],js:["Drupal"]}},{name:"Squarespace",category:"cms",confidence:1,checks:{text:["squarespace"],url:["squarespace"]}},{name:"Webflow",category:"cms",confidence:1,checks:{text:["webflow"],url:["webflow"]}},{name:"React",category:"framework",confidence:.9,checks:{js:["React","ReactDOM"],text:["react","data-reactroot"]}},{name:"Vue.js",category:"framework",confidence:.9,checks:{js:["Vue"],text:["vue"]}},{name:"Angular",category:"framework",confidence:.9,checks:{js:["ng","angular"],text:["ng-app","ng-controller"]}},{name:"Next.js",category:"framework",confidence:1,checks:{js:["__NEXT_DATA__"],text:["_next/static"]}},{name:"Nuxt.js",category:"framework",confidence:1,checks:{js:["__NUXT__"],text:["_nuxt/"]}},{name:"Svelte",category:"framework",confidence:.9,checks:{text:["svelte"]}},{name:"Google Analytics",category:"analytics",confidence:1,checks:{js:["gtag","ga","GoogleAnalyticsObject"],url:["google-analytics.com","googletagmanager.com"]}},{name:"Google Tag Manager",category:"analytics",confidence:1,checks:{js:["dataLayer"],url:["googletagmanager.com"]}},{name:"Mixpanel",category:"analytics",confidence:1,checks:{js:["mixpanel"],url:["mixpanel.com"]}},{name:"Amplitude",category:"analytics",confidence:1,checks:{js:["amplitude"],url:["amplitude.com"]}},{name:"Segment",category:"analytics",confidence:1,checks:{js:["analytics"],url:["segment.com","segment.io"]}},{name:"Adobe Analytics",category:"analytics",confidence:1,checks:{js:["s_account","_satellite"],url:["omtrdc.net","demdex.net"]}},{name:"Hotjar",category:"analytics",confidence:1,checks:{js:["hj"],url:["hotjar.com"]}},{name:"Facebook Pixel",category:"analytics",confidence:1,checks:{js:["fbq"],url:["facebook.net"]}},{name:"jQuery",category:"library",confidence:1,checks:{js:["jQuery","$"]}},{name:"Lodash",category:"library",confidence:1,checks:{js:["_"]}},{name:"D3.js",category:"library",confidence:1,checks:{js:["d3"]}},{name:"Chart.js",category:"library",confidence:1,checks:{js:["Chart"]}},{name:"Bootstrap",category:"library",confidence:.8,checks:{dom:[".container",".row",".col"],text:["bootstrap"]}},{name:"Tailwind CSS",category:"library",confidence:.8,checks:{dom:['[class*="tw-"]','[class*="bg-"]','[class*="text-"]'],text:["tailwind"]}},{name:"WooCommerce",category:"ecommerce",confidence:1,checks:{text:["woocommerce","wc-"],dom:[".woocommerce"]}},{name:"Magento",category:"ecommerce",confidence:1,checks:{text:["magento","Mage."],js:["Mage"]}},{name:"Cloudflare",category:"hosting",confidence:.7,checks:{text:["cloudflare"],url:["cloudflare"]}},{name:"AWS CloudFront",category:"hosting",confidence:.7,checks:{url:["cloudfront.net"]}},{name:"Netlify",category:"hosting",confidence:1,checks:{text:["netlify"],url:["netlify"]}},{name:"Vercel",category:"hosting",confidence:1,checks:{text:["vercel"],url:["vercel"]}}]},TechnologyDetector}(),EventEmitter=function(){function EventEmitter(){this._events=new Map}return EventEmitter.prototype.on=function(event,callback){this._events.has(event)||this._events.set(event,[]),this._events.get(event).push(callback)},EventEmitter.prototype.off=function(event,callback){var listeners=this._events.get(event);if(listeners){var index=listeners.indexOf(callback);index>-1&&listeners.splice(index,1),0===listeners.length&&this._events.delete(event)}},EventEmitter.prototype.emit=function(event){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];var listeners=this._events.get(event);listeners&&__spreadArray([],listeners,!0).forEach(function(callback){try{callback.apply(void 0,args)}catch(error){"production"!==process.env.NODE_ENV&&console.error("Event listener error:",error)}})},EventEmitter.prototype.once=function(event,callback){var _this=this,onceWrapper=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];callback.apply(void 0,args),_this.off(event,onceWrapper)};this.on(event,onceWrapper)},EventEmitter.prototype.removeAllListeners=function(event){event?this._events.delete(event):this._events.clear()},EventEmitter.prototype.listenerCount=function(event){var listeners=this._events.get(event);return listeners?listeners.length:0},EventEmitter.prototype.eventNames=function(){return Array.from(this._events.keys())},EventEmitter}(),WebSocketManager=function(_super){function WebSocketManager(config){void 0===config&&(config={});var _this=_super.call(this)||this;return _this.name="WebSocketManager",_this._socket=null,_this._messageQueue=[],_this._fallbackTransport=null,_this._heartbeatInterval=null,_this._heartbeatTimeout=null,_this._reconnectTimeout=null,_this._queueProcessorInterval=null,_this._heartbeatsMissed=0,_this._destroyed=!1,_this._pendingPings=new Map,_this._config={url:config.url||"",protocols:config.protocols||[],reconnect:!1!==config.reconnect,reconnectInterval:config.reconnectInterval||5e3,maxReconnectAttempts:config.maxReconnectAttempts||10,heartbeatInterval:config.heartbeatInterval||3e4,messageQueueSize:config.messageQueueSize||1e3,enableCompression:!1!==config.enableCompression,enableFallback:!1!==config.enableFallback,fallbackUrl:config.fallbackUrl||"",timeout:config.timeout||1e4,debug:config.debug||!1},_this._connectionState={status:"disconnected",url:_this._config.url,reconnectAttempts:0},_this._metrics={messagesSet:0,messagesReceived:0,reconnections:0,errors:0,averageLatency:0,uptime:0,lastActivity:0},_this._heartbeatConfig={interval:_this._config.heartbeatInterval,timeout:5e3,maxMissed:3,enabled:!0},_this._config.enableFallback&&_this._config.fallbackUrl&&(_this._fallbackTransport={type:"http",url:_this._config.fallbackUrl,enabled:!0,retryInterval:1e4}),_this}return __extends(WebSocketManager,_super),WebSocketManager.prototype.init=function(){isBrowser()?(this._startQueueProcessor(),this._config.debug&&console.log("[WebSocketManager] Initialized with config:",this._config)):this._config.debug&&console.warn("[WebSocketManager] Not in browser environment")},WebSocketManager.prototype.setSessionContext=function(sessionId,visitorId){this._sessionId=sessionId,this._visitorId=visitorId},WebSocketManager.prototype.connect=function(url){return __awaiter(this,void 0,void 0,function(){var connectUrl,_a,_this=this;return __generator(this,function(_b){if(this._destroyed)throw new Error("WebSocketManager has been destroyed");if(!(connectUrl=url||this._config.url))throw new Error("WebSocket URL is required");return(null===(_a=this._socket)||void 0===_a?void 0:_a.readyState)===WebSocket.OPEN&&this._connectionState.url===connectUrl?[2]:(this._socket&&this._cleanupConnection(),[2,new Promise(function(resolve,reject){try{_this._connectionState=__assign(__assign({},_this._connectionState),{status:"connecting",url:connectUrl}),delete _this._connectionState.lastError,_this._socket=new WebSocket(connectUrl,_this._config.protocols),_this._socket.binaryType="arraybuffer",_this._socket.onopen=function(event){_this._onOpen(event),resolve()},_this._socket.onclose=function(event){_this._onClose(event)},_this._socket.onerror=function(event){_this._onError(event),reject(new Error("WebSocket connection failed"))},_this._socket.onmessage=function(event){_this._onMessage(event)},setTimeout(function(){var _a;(null===(_a=_this._socket)||void 0===_a?void 0:_a.readyState)===WebSocket.CONNECTING&&(_this._socket.close(),reject(new Error("WebSocket connection timeout")))},_this._config.timeout)}catch(error){_this._connectionState.status="error",_this._connectionState.lastError=error,reject(error)}})])})})},WebSocketManager.prototype.disconnect=function(){this._socket&&this._socket.close(1e3,"Normal closure"),this._cleanupConnection(),this._connectionState.status="disconnected"},WebSocketManager.prototype.reconnect=function(){return __awaiter(this,void 0,void 0,function(){var error_1;return __generator(this,function(_a){switch(_a.label){case 0:if(this._connectionState.reconnectAttempts>=this._config.maxReconnectAttempts){if(this._config.debug&&console.warn("[WebSocketManager] Max reconnect attempts reached"),this._config.enableFallback&&this._fallbackTransport)return this._activateFallback("Max reconnection attempts reached"),[2];throw new Error("Max reconnection attempts reached")}this._connectionState.status="reconnecting",this._connectionState.reconnectAttempts++,this._metrics.reconnections++,this.emit("connection:reconnecting",this._connectionState),_a.label=1;case 1:return _a.trys.push([1,3,,4]),[4,this.connect()];case 2:return _a.sent(),this._connectionState.reconnectAttempts=0,this.emit("connection:reconnected",this._connectionState),[3,4];case 3:throw error_1=_a.sent(),this._config.debug&&console.error("[WebSocketManager] Reconnection failed:",error_1),this._scheduleReconnection(),error_1;case 4:return[2]}})})},WebSocketManager.prototype.send=function(message){return __awaiter(this,void 0,void 0,function(){var fullMessage;return __generator(this,function(_a){if(fullMessage=__assign(__assign({},message),{id:generateId(),timestamp:now(),sessionId:this._sessionId||"unknown",visitorId:this._visitorId||"unknown"}),!this.isConnected)return this._queueMessage(fullMessage),[2,!1];try{return this._socket.send(JSON.stringify(fullMessage)),this._metrics.messagesSet++,this._metrics.lastActivity=now(),this.emit("message:sent",fullMessage),[2,!0]}catch(error){return this._config.debug&&console.error("[WebSocketManager] Send failed:",error),this._queueMessage(fullMessage),this.emit("message:failed",{message:fullMessage,error:error}),[2,!1]}return[2]})})},WebSocketManager.prototype.sendEvent=function(event_1,data_1){return __awaiter(this,arguments,void 0,function(event,data,priority){return void 0===priority&&(priority="normal"),__generator(this,function(_a){return[2,this.send({type:"event",data:__assign({event:event},data),priority:priority,retry:"low"!==priority})]})})},WebSocketManager.prototype.sendHeartbeat=function(){if(this.isConnected){var pingId=generateId(),timestamp=now();this._pendingPings.set(pingId,timestamp),this.send({type:"heartbeat",data:{pingId:pingId,timestamp:timestamp},priority:"critical",retry:!1}),this._heartbeatsMissed=0,this.emit("heartbeat:sent",{timestamp:timestamp})}},WebSocketManager.prototype.getConnectionState=function(){return __assign({},this._connectionState)},WebSocketManager.prototype.getMetrics=function(){var uptime=this._connectionState.connectedAt?now()-this._connectionState.connectedAt:0;return __assign(__assign({},this._metrics),{uptime:uptime})},WebSocketManager.prototype.clearQueue=function(){this._messageQueue=[]},Object.defineProperty(WebSocketManager.prototype,"isConnected",{get:function(){var _a;return(null===(_a=this._socket)||void 0===_a?void 0:_a.readyState)===WebSocket.OPEN},enumerable:!1,configurable:!0}),Object.defineProperty(WebSocketManager.prototype,"connectionState",{get:function(){return this._connectionState},enumerable:!1,configurable:!0}),Object.defineProperty(WebSocketManager.prototype,"metrics",{get:function(){return this.getMetrics()},enumerable:!1,configurable:!0}),Object.defineProperty(WebSocketManager.prototype,"queueSize",{get:function(){return this._messageQueue.length},enumerable:!1,configurable:!0}),WebSocketManager.prototype.destroy=function(){this._destroyed=!0,this.disconnect(),this._clearTimers(),this.clearQueue(),this.removeAllListeners(),this._config.debug&&console.log("[WebSocketManager] Destroyed")},WebSocketManager.prototype._onOpen=function(_event){this._connectionState=__assign(__assign({},this._connectionState),{status:"connected",connectedAt:now()}),delete this._connectionState.disconnectedAt,delete this._connectionState.lastError,this._heartbeatConfig.enabled&&this._startHeartbeat(),this._processQueue(),this.emit("connection:open",this._connectionState),this._config.debug&&console.log("[WebSocketManager] Connected to:",this._connectionState.url)},WebSocketManager.prototype._onClose=function(event){var wasConnected="connected"===this._connectionState.status;this._connectionState=__assign(__assign({},this._connectionState),{status:"disconnected",disconnectedAt:now()}),this._cleanupConnection(),this.emit("connection:close",this._connectionState),this._config.debug&&console.log("[WebSocketManager] Disconnected:",event.code,event.reason),this._config.reconnect&&wasConnected&&!this._destroyed&&this._scheduleReconnection()},WebSocketManager.prototype._onError=function(event){var error=new Error(event.message||"WebSocket error");this._connectionState.lastError=error,this._connectionState.status="error",this._metrics.errors++,this.emit("connection:error",{error:error,state:this._connectionState}),this._config.debug&&console.error("[WebSocketManager] Error:",error)},WebSocketManager.prototype._onMessage=function(event){var _a;try{var message=JSON.parse(event.data);if(this._metrics.messagesReceived++,this._metrics.lastActivity=now(),"heartbeat"===message.type&&(null===(_a=message.data)||void 0===_a?void 0:_a.pingId))return void this._handleHeartbeatResponse(message);if("ack"===message.type)return void this._handleAcknowledgment(message);this.emit("message:received",message),this._config.debug&&console.log("[WebSocketManager] Message received:",message)}catch(error){this._config.debug&&console.error("[WebSocketManager] Failed to parse message:",error)}},WebSocketManager.prototype._handleHeartbeatResponse=function(message){var _a=message.data,pingId=_a.pingId,timestamp=_a.timestamp;if(this._pendingPings.has(pingId)){var sendTime=this._pendingPings.get(pingId),latency=now()-sendTime;this._connectionState.latency=latency,this._metrics.averageLatency=(this._metrics.averageLatency+latency)/2,this._pendingPings.delete(pingId),this._heartbeatsMissed=0,this.emit("heartbeat:received",{timestamp:timestamp,latency:latency})}},WebSocketManager.prototype._handleAcknowledgment=function(message){var _a,messageId=null===(_a=message.data)||void 0===_a?void 0:_a.messageId;messageId&&(this._messageQueue=this._messageQueue.filter(function(msg){return msg.id!==messageId}))},WebSocketManager.prototype._queueMessage=function(message){if(this._messageQueue.length>=this._config.messageQueueSize){var dropped=this._messageQueue.shift();this.emit("queue:full",{size:this._messageQueue.length,dropped:dropped})}var queuedMessage=__assign(__assign({},message),{attempts:0,nextRetry:now(),maxRetries:"critical"===message.priority?5:3});this._messageQueue.push(queuedMessage),this.emit("message:queued",message)},WebSocketManager.prototype._processQueue=function(){if(this.isConnected&&0!==this._messageQueue.length)for(var messagesToSend=this._messageQueue.filter(function(msg){return msg.nextRetry<=now()&&msg.attempts<msg.maxRetries}),_loop_1=function(message){try{this_1._socket.send(JSON.stringify(message)),this_1._messageQueue=this_1._messageQueue.filter(function(msg){return msg.id!==message.id}),this_1._metrics.messagesSet++,this_1.emit("message:sent",message)}catch(error){message.attempts++,message.nextRetry=now()+1e3*message.attempts,message.attempts>=message.maxRetries&&(this_1._messageQueue=this_1._messageQueue.filter(function(msg){return msg.id!==message.id}),this_1.emit("message:failed",{message:message,error:error}))}},this_1=this,_i=0,messagesToSend_1=messagesToSend;_i<messagesToSend_1.length;_i++)_loop_1(messagesToSend_1[_i])},WebSocketManager.prototype._startQueueProcessor=function(){var _this=this;this._queueProcessorInterval&&clearInterval(this._queueProcessorInterval),this._queueProcessorInterval=window.setInterval(function(){_this._processQueue()},1e3)},WebSocketManager.prototype._startHeartbeat=function(){var _this=this;this._heartbeatInterval&&clearInterval(this._heartbeatInterval),this._heartbeatInterval=window.setInterval(function(){_this.isConnected&&(_this.sendHeartbeat(),_this._heartbeatTimeout=window.setTimeout(function(){_this._heartbeatsMissed++,_this._heartbeatsMissed>=_this._heartbeatConfig.maxMissed&&(_this._config.debug&&console.warn("[WebSocketManager] Too many missed heartbeats, reconnecting"),_this.reconnect().catch(function(){}))},_this._heartbeatConfig.timeout))},this._heartbeatConfig.interval)},WebSocketManager.prototype._scheduleReconnection=function(){var _this=this;this._reconnectTimeout&&clearTimeout(this._reconnectTimeout);var delay=this._config.reconnectInterval*Math.pow(1.5,this._connectionState.reconnectAttempts);this._reconnectTimeout=window.setTimeout(function(){_this._destroyed||"connected"===_this._connectionState.status||_this.reconnect().catch(function(){})},delay)},WebSocketManager.prototype._activateFallback=function(reason){this._fallbackTransport&&(this.emit("fallback:activated",{reason:reason,url:this._fallbackTransport.url}),this._config.debug&&console.log("[WebSocketManager] Fallback activated:",reason))},WebSocketManager.prototype._cleanupConnection=function(){this._clearTimers(),this._pendingPings.clear(),this._heartbeatsMissed=0},WebSocketManager.prototype._clearTimers=function(){this._heartbeatInterval&&(clearInterval(this._heartbeatInterval),this._heartbeatInterval=null),this._heartbeatTimeout&&(clearTimeout(this._heartbeatTimeout),this._heartbeatTimeout=null),this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null),this._queueProcessorInterval&&(clearInterval(this._queueProcessorInterval),this._queueProcessorInterval=null)},WebSocketManager}(EventEmitter),SessionManager=function(){function SessionManager(storage,options){void 0===options&&(options={}),this._currentSession=null,this._fingerprint=null,this._listeners=new Map,this._destroyed=!1,this.SESSION_KEY="session",this.VISITOR_KEY="visitor",this.FINGERPRINT_KEY="fingerprint",this.TABS_KEY="active_tabs",this.HEARTBEAT_KEY="heartbeat",this._storage=storage,this._options=__assign({sessionTimeout:18e5,enableCrossTabs:!0,enableFingerprinting:!0,fingerprintElements:{screen:!0,timezone:!0,language:!0,platform:!0,plugins:!0,canvas:!1},sessionValidation:!0,storagePrefix:"opt_session_"},options),this._tabId=this._generateTabId(),this._options.enableFingerprinting&&this._generateFingerprint(),this._options.enableCrossTabs&&isBrowser()&&(this._setupCrossTabSync(),this._startHeartbeat())}return SessionManager.prototype.initializeSession=function(){return __awaiter(this,void 0,void 0,function(){var restored,newSession,error_1,fallback;return __generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,3,,4]),[4,this._restoreSession()];case 1:return(restored=_a.sent())?(this._currentSession=restored,this._emit("session:restored",restored),[2,restored]):[4,this._createNewSession()];case 2:return newSession=_a.sent(),this._currentSession=newSession,this._saveSession(newSession),this._emit("session:created",newSession),[2,newSession];case 3:return error_1=_a.sent(),console.error("Session initialization failed:",error_1),fallback=this._createBasicSession(),this._currentSession=fallback,[2,fallback];case 4:return[2]}})})},SessionManager.prototype.getCurrentSession=function(){return this._currentSession},SessionManager.prototype.updateActivity=function(){this._currentSession&&(this._currentSession.lastActivity=now(),this._currentSession.pageViews++,this._saveSession(this._currentSession))},SessionManager.prototype.validateSession=function(){return __awaiter(this,void 0,void 0,function(){var reasons,isValid,currentFingerprint,storedFingerprint;return __generator(this,function(_a){switch(_a.label){case 0:return this._currentSession?(reasons=[],isValid=!0,now()-this._currentSession.lastActivity>this._options.sessionTimeout&&(isValid=!1,reasons.push("Session timeout exceeded")),this._options.enableFingerprinting&&this._options.sessionValidation?[4,this._generateFingerprint()]:[3,2]):[2,{isValid:!1,reasons:["No active session"],fingerprint:this._fingerprint,lastValidated:now()}];case 1:currentFingerprint=_a.sent(),(storedFingerprint=this._getStoredFingerprint())&&currentFingerprint.hash!==storedFingerprint.hash&&this._checkCriticalFingerprintMismatch(currentFingerprint,storedFingerprint)&&(isValid=!1,reasons.push("Session fingerprint validation failed")),_a.label=2;case 2:return[2,{isValid:isValid,reasons:reasons,fingerprint:this._fingerprint,lastValidated:now()}]}})})},SessionManager.prototype.invalidateSession=function(){this._currentSession&&(this._emit("session:invalid",this._currentSession),this._currentSession=null,this._storage.remove(this.SESSION_KEY))},SessionManager.prototype.getFingerprint=function(){return this._fingerprint},SessionManager.prototype.on=function(event,callback){this._listeners.has(event)||this._listeners.set(event,[]),this._listeners.get(event).push(callback)},SessionManager.prototype.off=function(event,callback){var listeners=this._listeners.get(event);if(listeners){var index=listeners.indexOf(callback);index>-1&&listeners.splice(index,1)}},SessionManager.prototype.destroy=function(){if(!this._destroyed){this._syncTimer&&clearInterval(this._syncTimer),this._heartbeatTimer&&clearInterval(this._heartbeatTimer);try{this._removeFromActiveTabs()}catch(error){}this._listeners.clear(),this._destroyed=!0}},SessionManager.prototype._restoreSession=function(){return __awaiter(this,void 0,void 0,function(){var sessionData,session;return __generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,3]),(sessionData=this._storage.get(this.SESSION_KEY))&&(session=safeJsonParse(sessionData,null))?[4,this._validateStoredSession(session)]:[2,null];case 1:return _a.sent().isValid?[2,session]:(this._storage.remove(this.SESSION_KEY),[2,null]);case 2:return _a.sent(),[2,null];case 3:return[2]}})})},SessionManager.prototype._createNewSession=function(){return __awaiter(this,void 0,void 0,function(){var visitorId,session;return __generator(this,function(_a){try{visitorId=this._storage.get(this.VISITOR_KEY)||generateVisitorId(),this._storage.set(this.VISITOR_KEY,visitorId)}catch(error){visitorId=generateVisitorId()}session={sessionId:generateSessionId(),visitorId:visitorId,startTime:now(),lastActivity:now(),pageViews:0,platform:detectPlatform(),userAgent:getUserAgent(),referrer:getReferrer(),landingPage:getCurrentUrl()};try{this._addToActiveTabs()}catch(error){}return[2,session]})})},SessionManager.prototype._createBasicSession=function(){return{sessionId:generateSessionId(),visitorId:generateVisitorId(),startTime:now(),lastActivity:now(),pageViews:0,platform:detectPlatform(),userAgent:getUserAgent(),referrer:getReferrer(),landingPage:getCurrentUrl()}},SessionManager.prototype._saveSession=function(session){try{this._storage.set(this.SESSION_KEY,safeJsonStringify(session))}catch(error){this._options.debug&&console.warn("Failed to save session:",error)}},SessionManager.prototype._generateFingerprint=function(){return __awaiter(this,void 0,void 0,function(){var elements,fingerprint,_a,hashString;return __generator(this,function(_b){switch(_b.label){case 0:return isBrowser()?(elements=this._options.fingerprintElements,fingerprint={},elements.screen&&(fingerprint.screenResolution="".concat(screen.width,"x").concat(screen.height)),elements.timezone&&(fingerprint.timezone=(new Date).getTimezoneOffset()),elements.language&&(fingerprint.language=navigator.language||"unknown"),elements.platform&&(fingerprint.platform=detectPlatform(),fingerprint.browser=detectBrowser()),elements.plugins&&(fingerprint.pluginsHash=this._hashPlugins()),elements.canvas?(_a=fingerprint,[4,this._generateCanvasFingerprint()]):[3,2]):(this._fingerprint={screenResolution:"unknown",timezone:0,language:"unknown",platform:"server",browser:"unknown",pluginsHash:"unknown",hash:"server-side"},[2,this._fingerprint]);case 1:_a.canvasHash=_b.sent(),_b.label=2;case 2:return hashString=Object.values(fingerprint).join("|"),fingerprint.hash=this._simpleHash(hashString).toString(),this._fingerprint=fingerprint,this._storage.set(this.FINGERPRINT_KEY,safeJsonStringify(this._fingerprint)),[2,this._fingerprint]}})})},SessionManager.prototype._getStoredFingerprint=function(){var stored=this._storage.get(this.FINGERPRINT_KEY);return stored?safeJsonParse(stored,null):null},SessionManager.prototype._checkCriticalFingerprintMismatch=function(current,stored){return current.platform!==stored.platform||current.browser!==stored.browser||current.screenResolution!==stored.screenResolution},SessionManager.prototype._validateStoredSession=function(session){return __awaiter(this,void 0,void 0,function(){var timeSinceActivity,reasons,isValid;return __generator(this,function(_a){return timeSinceActivity=now()-session.lastActivity,reasons=[],isValid=!0,timeSinceActivity>this._options.sessionTimeout&&(isValid=!1,reasons.push("Session expired")),[2,{isValid:isValid,reasons:reasons,fingerprint:this._fingerprint,lastValidated:now()}]})})},SessionManager.prototype._setupCrossTabSync=function(){var _this=this;isBrowser()&&(window.addEventListener("storage",function(event){event.key===_this._getStorageKey(_this.SESSION_KEY)&&_this._handleSessionSync(event.newValue)}),this._syncTimer=window.setInterval(function(){_this._checkTabSync()},5e3))},SessionManager.prototype._startHeartbeat=function(){var _this=this;isBrowser()&&(this._heartbeatTimer=window.setInterval(function(){_this._updateHeartbeat(),_this._cleanupInactiveTabs()},1e4))},SessionManager.prototype._handleSessionSync=function(newSessionData){var _a;if(newSessionData){var session=safeJsonParse(newSessionData,null);session&&session.sessionId!==(null===(_a=this._currentSession)||void 0===_a?void 0:_a.sessionId)&&(this._currentSession=session,this._emit("session:synchronized",session))}},SessionManager.prototype._checkTabSync=function(){var activeTabs=this._getActiveTabs(),currentTime=now(),thisTab=activeTabs[this._tabId];(!thisTab||currentTime-thisTab.lastHeartbeat>3e4)&&this._addToActiveTabs()},SessionManager.prototype._updateHeartbeat=function(){var _a,heartbeat={tabId:this._tabId,timestamp:now(),sessionId:(null===(_a=this._currentSession)||void 0===_a?void 0:_a.sessionId)||"unknown"};this._storage.set(this.HEARTBEAT_KEY,safeJsonStringify(heartbeat))},SessionManager.prototype._getActiveTabs=function(){try{var stored=this._storage.get(this.TABS_KEY);return stored?safeJsonParse(stored,{}):{}}catch(error){return{}}},SessionManager.prototype._addToActiveTabs=function(){var _a;try{var activeTabs=this._getActiveTabs();activeTabs[this._tabId]={startTime:now(),lastHeartbeat:now(),sessionId:(null===(_a=this._currentSession)||void 0===_a?void 0:_a.sessionId)||"pending"},this._storage.set(this.TABS_KEY,safeJsonStringify(activeTabs))}catch(error){}},SessionManager.prototype._removeFromActiveTabs=function(){try{var activeTabs=this._getActiveTabs();delete activeTabs[this._tabId],this._storage.set(this.TABS_KEY,safeJsonStringify(activeTabs))}catch(error){}},SessionManager.prototype._cleanupInactiveTabs=function(){for(var activeTabs=this._getActiveTabs(),currentTime=now(),hasChanges=!1,_i=0,_a=Object.entries(activeTabs);_i<_a.length;_i++){var _b=_a[_i],tabId=_b[0];currentTime-_b[1].lastHeartbeat>6e4&&(delete activeTabs[tabId],hasChanges=!0)}hasChanges&&this._storage.set(this.TABS_KEY,safeJsonStringify(activeTabs))},SessionManager.prototype._generateTabId=function(){return"tab_"+Math.random().toString(36).substr(2,9)+"_"+now()},SessionManager.prototype._getStorageKey=function(key){return this._options.storagePrefix+key},SessionManager.prototype._hashPlugins=function(){if(!isBrowser()||!navigator.plugins)return"unknown";var plugins=Array.from(navigator.plugins).map(function(plugin){return plugin.name}).sort().join("|");return this._simpleHash(plugins).toString()},SessionManager.prototype._generateCanvasFingerprint=function(){return __awaiter(this,void 0,void 0,function(){var canvas,ctx;return __generator(this,function(_a){if(!isBrowser())return[2,"unknown"];try{return canvas=document.createElement("canvas"),(ctx=canvas.getContext("2d"))?(ctx.textBaseline="top",ctx.font="14px Arial",ctx.fillText("Fingerprint test ",2,2),[2,this._simpleHash(canvas.toDataURL()).toString()]):[2,"unknown"]}catch(_b){return[2,"canvas-blocked"]}return[2]})})},SessionManager.prototype._simpleHash=function(str){for(var hash=0,i=0;i<str.length;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash;return Math.abs(hash)},SessionManager.prototype._emit=function(type,session){var event={type:type,session:session,timestamp:now(),tabId:this._tabId};(this._listeners.get(type)||[]).forEach(function(callback){try{callback(event)}catch(error){console.error("Session event listener error:",error)}})},SessionManager}(),Storage=function(){function Storage(prefix){void 0===prefix&&(prefix="opt_"),this._fallback=new Map,this._prefix=prefix}return Storage.prototype.get=function(key){var prefixedKey=this._prefix+key;try{if(isBrowser()&&window.localStorage&&null!==(value=localStorage.getItem(prefixedKey))){if((parsed=safeJsonParse(value,null))&&this._isNotExpired(parsed.expiry))return parsed.value;parsed&&localStorage.removeItem(prefixedKey)}}catch(e){}try{var value,parsed;if(isBrowser()&&window.sessionStorage&&null!==(value=sessionStorage.getItem(prefixedKey))&&(parsed=safeJsonParse(value,null))&&this._isNotExpired(parsed.expiry))return parsed.value}catch(e){}try{if(isBrowser()){var cookieValue=this._getCookie(prefixedKey);if(cookieValue)return cookieValue}}catch(e){}return this._fallback.get(prefixedKey)||null},Storage.prototype.set=function(key,value,expiry){var _this=this,prefixedKey=this._prefix+key,storageValue=safeJsonStringify({value:value,expiry:expiry});try{if(isBrowser()&&window.localStorage)return void localStorage.setItem(prefixedKey,storageValue)}catch(e){}try{if(isBrowser()&&window.sessionStorage)return void sessionStorage.setItem(prefixedKey,storageValue)}catch(e){}try{if(isBrowser()&&value.length<4e3)return void this._setCookie(prefixedKey,value,expiry)}catch(e){}this._fallback.set(prefixedKey,value),this._fallback.size>100&&Array.from(this._fallback.entries()).slice(0,20).forEach(function(_a){var k=_a[0];return _this._fallback.delete(k)})},Storage.prototype.remove=function(key){var prefixedKey=this._prefix+key;try{isBrowser()&&window.localStorage&&localStorage.removeItem(prefixedKey)}catch(e){}try{isBrowser()&&window.sessionStorage&&sessionStorage.removeItem(prefixedKey)}catch(e){}try{isBrowser()&&this._deleteCookie(prefixedKey)}catch(e){}this._fallback.delete(prefixedKey)},Storage.prototype.clear=function(){var _this=this;this._getAllKeys().forEach(function(key){return _this.remove(key.replace(_this._prefix,""))}),this._fallback.clear()},Storage.prototype._isNotExpired=function(expiry){return!expiry||Date.now()<expiry},Storage.prototype._getAllKeys=function(){var _this=this,keys=[];try{if(isBrowser()&&window.localStorage)for(var i=0;i<localStorage.length;i++)(key=localStorage.key(i))&&key.startsWith(this._prefix)&&keys.push(key)}catch(e){}try{if(isBrowser()&&window.sessionStorage)for(i=0;i<sessionStorage.length;i++){var key;(key=sessionStorage.key(i))&&key.startsWith(this._prefix)&&keys.push(key)}}catch(e){}return this._fallback.forEach(function(_,key){key.startsWith(_this._prefix)&&keys.push(key)}),Array.from(new Set(keys))},Storage.prototype._getCookie=function(name){var _a;if(!isBrowser())return null;var parts="; ".concat(document.cookie).split("; ".concat(name,"="));if(2===parts.length){var cookieValue=null===(_a=parts.pop())||void 0===_a?void 0:_a.split(";").shift();return cookieValue?decodeURIComponent(cookieValue):null}return null},Storage.prototype._setCookie=function(name,value,expiry){if(isBrowser()){var cookieString="".concat(name,"=").concat(encodeURIComponent(value),"; path=/");if(expiry){var expiryDate=new Date(expiry);cookieString+="; expires=".concat(expiryDate.toUTCString())}"https:"===location.protocol&&(cookieString+="; secure"),cookieString+="; samesite=lax",document.cookie=cookieString}},Storage.prototype._deleteCookie=function(name){isBrowser()&&(document.cookie="".concat(name,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"))},Storage}(),Tracker=function(_super){function Tracker(){var _this=_super.call(this)||this;return _this.isInitialized=!1,_this._modules=new Map,_this._eventQueue=[],_this._destroyed=!1,_this._storage=new Storage,_this._sessionManager=new SessionManager(_this._storage),_this.config={apiUrl:"",projectId:"",debug:!1,enableGDPR:!0,sessionTimeout:18e5,batchSize:10,flushInterval:5e3,platform:"auto"},_this.session=_this._createEmptySession(),_this}return __extends(Tracker,_super),Tracker.prototype.init=function(config){return __awaiter(this,void 0,void 0,function(){var sessionOptions,_a,behavioralTracker,technologyDetector,wsConfig,cleanConfig,webSocketManager,error_1,_b,_this=this;return __generator(this,function(_c){switch(_c.label){case 0:if(this.isInitialized)return this.config.debug&&console.warn("Tracker already initialized"),[2];if(this.config=deepMerge(this.config,config),!this.config.apiUrl||!this.config.projectId)throw new Error("apiUrl and projectId are required");return this._storage=new Storage("opt_".concat(this.config.projectId,"_")),sessionOptions={sessionTimeout:this.config.sessionTimeout||18e5,enableCrossTabs:!0,enableFingerprinting:!0,sessionValidation:!0,storagePrefix:"opt_".concat(this.config.projectId,"_session_")},this._sessionManager=new SessionManager(this._storage,sessionOptions),this._sessionManager.on("session:created",function(event){_this.session=event.session,_this.emit("session:created",event),_this.config.debug&&console.log("New session created:",event)}),this._sessionManager.on("session:restored",function(event){_this.session=event.session,_this.emit("session:restored",event),_this.config.debug&&console.log("Session restored:",event)}),this._sessionManager.on("session:synchronized",function(event){_this.session=event.session,_this.emit("session:synchronized",event),_this.config.debug&&console.log("Session synchronized across tabs:",event)}),this._sessionManager.on("session:invalid",function(event){_this.emit("session:invalid",event),_this.config.debug&&console.log("Session invalidated:",event)}),_a=this,[4,this._sessionManager.initializeSession()];case 1:if(_a.session=_c.sent(),(behavioralTracker=new BehavioralTracker({enableClickTracking:!0,enableScrollTracking:!0,enableFormTracking:!0,enableMouseTracking:!!this.config.debug,enableVisibilityTracking:!0,enablePerformanceTracking:!0})).setTracker(this),this.use(behavioralTracker),technologyDetector=new TechnologyDetector,this.use(technologyDetector),!(null===(_b=this.config.websocket)||void 0===_b?void 0:_b.enabled)||!isBrowser())return[3,5];if(wsConfig=this.config.websocket,cleanConfig={url:wsConfig.url||""},void 0!==this.config.debug&&(cleanConfig.debug=this.config.debug),wsConfig.protocols&&(cleanConfig.protocols=wsConfig.protocols),void 0!==wsConfig.reconnect&&(cleanConfig.reconnect=wsConfig.reconnect),wsConfig.reconnectInterval&&(cleanConfig.reconnectInterval=wsConfig.reconnectInterval),wsConfig.maxReconnectAttempts&&(cleanConfig.maxReconnectAttempts=wsConfig.maxReconnectAttempts),wsConfig.heartbeatInterval&&(cleanConfig.heartbeatInterval=wsConfig.heartbeatInterval),wsConfig.messageQueueSize&&(cleanConfig.messageQueueSize=wsConfig.messageQueueSize),void 0!==wsConfig.enableCompression&&(cleanConfig.enableCompression=wsConfig.enableCompression),void 0!==wsConfig.enableFallback&&(cleanConfig.enableFallback=wsConfig.enableFallback),wsConfig.fallbackUrl&&(cleanConfig.fallbackUrl=wsConfig.fallbackUrl),wsConfig.timeout&&(cleanConfig.timeout=wsConfig.timeout),(webSocketManager=new WebSocketManager(cleanConfig)).setSessionContext(this.session.sessionId,this.session.visitorId),this.use(webSocketManager),!wsConfig.autoConnect||!wsConfig.url)return[3,5];_c.label=2;case 2:return _c.trys.push([2,4,,5]),[4,webSocketManager.connect()];case 3:return _c.sent(),this.config.debug&&console.log("WebSocket auto-connected"),[3,5];case 4:return error_1=_c.sent(),this.config.debug&&console.warn("WebSocket auto-connect failed:",error_1),[3,5];case 5:return this._startFlushTimer(),isBrowser()&&domReady(function(){_this.pageView()}),this.isInitialized=!0,this.emit("initialized",this.config),this.config.debug&&console.log("Tracker initialized",{config:this.config,session:this.session,fingerprint:this._sessionManager.getFingerprint(),modules:Array.from(this._modules.keys())}),[2]}})})},Tracker.prototype.track=function(event,data){if(void 0===data&&(data={}),this.isInitialized)if(this.hasConsent()){var eventData={type:"custom",element:event,value:data,timestamp:now(),sessionId:this.session.sessionId,visitorId:this.session.visitorId,metadata:data};this._queueEvent(eventData),this.emit("track",eventData),this.config.debug&&console.log("Event tracked",eventData)}else this.config.debug&&console.warn("No consent for tracking");else this.config.debug&&console.warn("Tracker not initialized")},Tracker.prototype.identify=function(visitorId,traits){void 0===traits&&(traits={}),this.isInitialized&&(this.session.visitorId=visitorId,this.track("identify",{visitorId:visitorId,traits:traits}),this.emit("identify",{visitorId:visitorId,traits:traits}))},Tracker.prototype.pageView=function(data){if(void 0===data&&(data={}),this.isInitialized&&this.hasConsent()){var techStack=this.getTechnologyStack(),pageViewData=__assign({url:getCurrentUrl(),title:getCurrentTitle(),timestamp:now(),sessionId:this.session.sessionId,visitorId:this.session.visitorId,referrer:getReferrer()},data);this._sessionManager.updateActivity(),this.session=this._sessionManager.getCurrentSession()||this.session,this._queueEvent({type:"pageview",element:pageViewData.url,value:pageViewData.title,timestamp:pageViewData.timestamp,sessionId:pageViewData.sessionId,visitorId:pageViewData.visitorId,metadata:__assign(__assign({},pageViewData),{techStack:techStack})}),this.emit("pageview",__assign(__assign({},pageViewData),{techStack:techStack})),this.config.debug&&console.log("Page view tracked",__assign(__assign({},pageViewData),{techStack:techStack}))}},Tracker.prototype.use=function(module){this._modules.has(module.name)?this.config.debug&&console.warn("Module ".concat(module.name," already registered")):(this._modules.set(module.name,module),this.isInitialized&&module.init(),this.emit("module:added",module))},Tracker.prototype.getModule=function(name){return this._modules.get(name)||null},Tracker.prototype.getTechnologyStack=function(){var techModule=this.getModule("TechnologyDetector");return techModule?techModule.getCurrentTechStack():{}},Tracker.prototype.connectWebSocket=function(){return __awaiter(this,void 0,void 0,function(){var webSocketManager;return __generator(this,function(_a){if(!(webSocketManager=this.getModule("WebSocketManager")))throw new Error("WebSocket module not initialized");return[2,webSocketManager.connect()]})})},Tracker.prototype.disconnectWebSocket=function(){var webSocketManager=this.getModule("WebSocketManager");webSocketManager&&webSocketManager.disconnect()},Tracker.prototype.sendWebSocketEvent=function(event_1,data_1){return __awaiter(this,arguments,void 0,function(event,data,priority){var webSocketManager;return void 0===priority&&(priority="normal"),__generator(this,function(_a){return(webSocketManager=this.getModule("WebSocketManager"))?[2,webSocketManager.sendEvent(event,data,priority)]:[2,!1]})})},Tracker.prototype.getWebSocketState=function(){var webSocketManager=this.getModule("WebSocketManager");return webSocketManager?webSocketManager.getConnectionState():null},Tracker.prototype.getWebSocketMetrics=function(){var webSocketManager=this.getModule("WebSocketManager");return webSocketManager?webSocketManager.getMetrics():null},Tracker.prototype.setConsent=function(consent){this._storage.set("consent",JSON.stringify(consent)),this.emit("consent:changed",consent),this.config.debug&&console.log("Consent updated",consent)},Tracker.prototype.hasConsent=function(){if(!this.config.enableGDPR)return!0;var consentData=this._storage.get("consent");if(!consentData)return!1;try{var consent=JSON.parse(consentData);return consent.hasConsent&&consent.purposes.analytics}catch(_a){return!1}},Tracker.prototype.showConsentBanner=function(){var gdprModule=this.getModule("GDPRCompliance");gdprModule?gdprModule.showConsentBanner():this.config.debug&&console.warn("GDPR Compliance module not found")},Tracker.prototype.hideConsentBanner=function(){var gdprModule=this.getModule("GDPRCompliance");gdprModule?gdprModule.hideConsentBanner():this.config.debug&&console.warn("GDPR Compliance module not found")},Tracker.prototype.getGDPRConsent=function(){var gdprModule=this.getModule("GDPRCompliance");return gdprModule?gdprModule.getConsent():null},Tracker.prototype.setGDPRConsent=function(consent){var gdprModule=this.getModule("GDPRCompliance");gdprModule?gdprModule.setConsent(consent):this.config.debug&&console.warn("GDPR Compliance module not found")},Tracker.prototype.withdrawConsent=function(category){var gdprModule=this.getModule("GDPRCompliance");gdprModule?gdprModule.withdrawConsent(category):this.config.debug&&console.warn("GDPR Compliance module not found")},Tracker.prototype.requestDataAccess=function(email){return __awaiter(this,void 0,void 0,function(){var gdprModule;return __generator(this,function(_a){if(gdprModule=this.getModule("GDPRCompliance"))return[2,gdprModule.requestDataAccess(email)];throw new Error("GDPR Compliance module not found")})})},Tracker.prototype.requestDataDeletion=function(email){return __awaiter(this,void 0,void 0,function(){var gdprModule;return __generator(this,function(_a){if(gdprModule=this.getModule("GDPRCompliance"))return[2,gdprModule.requestDataDeletion(email)];throw new Error("GDPR Compliance module not found")})})},Tracker.prototype.requestDataPortability=function(email){return __awaiter(this,void 0,void 0,function(){var gdprModule;return __generator(this,function(_a){if(gdprModule=this.getModule("GDPRCompliance"))return[2,gdprModule.requestDataPortability(email)];throw new Error("GDPR Compliance module not found")})})},Tracker.prototype.getPrivacySettings=function(){var gdprModule=this.getModule("GDPRCompliance");return gdprModule?gdprModule.getPrivacySettings():null},Tracker.prototype.setPrivacySettings=function(settings){var gdprModule=this.getModule("GDPRCompliance");gdprModule?gdprModule.setPrivacySettings(settings):this.config.debug&&console.warn("GDPR Compliance module not found")},Tracker.prototype.isGDPRCompliant=function(){var gdprModule=this.getModule("GDPRCompliance");return gdprModule?gdprModule.isCompliant():!this.config.enableGDPR},Tracker.prototype.exportUserData=function(visitorId){return __awaiter(this,void 0,void 0,function(){var gdprModule;return __generator(this,function(_a){if(gdprModule=this.getModule("GDPRCompliance"))return[2,gdprModule.exportUserData(visitorId||this.session.visitorId)];throw new Error("GDPR Compliance module not found")})})},Tracker.prototype.flush=function(){return __awaiter(this,void 0,void 0,function(){var events,error_2,_a;return __generator(this,function(_b){switch(_b.label){case 0:if(0===this._eventQueue.length)return[2];events=__spreadArray([],this._eventQueue,!0),this._eventQueue=[],_b.label=1;case 1:return _b.trys.push([1,3,,4]),[4,this._sendEvents(events)];case 2:return _b.sent(),this.emit("events:sent",events),[3,4];case 3:return error_2=_b.sent(),(_a=this._eventQueue).unshift.apply(_a,events),this.emit("events:failed",error_2),this.config.debug&&console.error("Failed to send events",error_2),[3,4];case 4:return[2]}})})},Tracker.prototype.destroy=function(){this._destroyed||(this._flushTimer&&clearInterval(this._flushTimer),this.flush().catch(function(){}),this._sessionManager.destroy(),this._modules.forEach(function(module){module.destroy&&module.destroy()}),this._modules.clear(),this.removeAllListeners(),this._destroyed=!0,this.isInitialized=!1)},Tracker.prototype._createEmptySession=function(){return{sessionId:"",visitorId:"",startTime:0,lastActivity:0,pageViews:0,platform:"",userAgent:"",landingPage:""}},Tracker.prototype._queueEvent=function(event){this._eventQueue.push(event),this._eventQueue.length>=this.config.batchSize&&this.flush().catch(function(){})},Tracker.prototype._startFlushTimer=function(){var _this=this;this._flushTimer&&clearInterval(this._flushTimer),this._flushTimer=window.setInterval(function(){_this._eventQueue.length>0&&_this.flush().catch(function(){})},this.config.flushInterval)},Tracker.prototype._sendEvents=function(events){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.config.debug&&console.log("Sending events",events),[4,new Promise(function(resolve){return setTimeout(resolve,100)})];case 1:return _a.sent(),[2]}})})},Tracker}(EventEmitter),GDPRCompliance=function(_super){function GDPRCompliance(config,storage){var _a,_b,_c,_d,_e,_f;void 0===config&&(config={});var _this=_super.call(this)||this;return _this.name="GDPRCompliance",_this._consent=null,_this._bannerElement=null,_this._initialized=!1,_this._defaultTexts={bannerTitle:"We value your privacy",bannerDescription:"We use cookies and similar technologies to enhance your experience, analyze usage, and assist with marketing. You can manage your preferences at any time.",acceptAll:"Accept All",rejectAll:"Reject All",customize:"Customize",savePreferences:"Save Preferences",necessary:"Necessary",analytics:"Analytics",marketing:"Marketing",privacyPolicy:"Privacy Policy",cookiePolicy:"Cookie Policy"},_this._config=__assign({enabled:!0,consentBanner:__assign({enabled:!0,position:"bottom",theme:"light",texts:_this._defaultTexts,showOnEveryPage:!1,respectDoNotTrack:!0},config.consentBanner),cookieCategories:_this._getDefaultCookieCategories(),dataRetention:__assign({defaultDays:730,automaticDeletion:!0},config.dataRetention),userRights:__assign({enableDataAccess:!0,enableDataDeletion:!0,enableDataPortability:!0,enableOptOut:!0},config.userRights),privacyByDesign:__assign({dataMinimization:!0,purposeLimitation:!0,storageMinimization:!0,autoAnonymization:!0},config.privacyByDesign),legalBasis:__assign({type:"consent",description:"User consent for data processing"},config.legalBasis)},config),_this._cookieCategories=_this._config.cookieCategories||_this._getDefaultCookieCategories(),_this._privacySettings={dataMinimization:(null===(_a=_this._config.privacyByDesign)||void 0===_a?void 0:_a.dataMinimization)||!0,anonymizeIPs:!0,respectDoNotTrack:(null===(_b=_this._config.consentBanner)||void 0===_b?void 0:_b.respectDoNotTrack)||!0,cookielessTracking:!1,storageMinimization:(null===(_c=_this._config.privacyByDesign)||void 0===_c?void 0:_c.storageMinimization)||!0,automaticDeletion:(null===(_d=_this._config.dataRetention)||void 0===_d?void 0:_d.automaticDeletion)||!0,purposeLimitation:(null===(_e=_this._config.privacyByDesign)||void 0===_e?void 0:_e.purposeLimitation)||!0,dataRetentionDays:(null===(_f=_this._config.dataRetention)||void 0===_f?void 0:_f.defaultDays)||730,consentRequired:!0},_this._storage=storage||(isBrowser()?localStorage:{getItem:function(){return null},setItem:function(){},removeItem:function(){},clear:function(){}}),_this}return __extends(GDPRCompliance,_super),GDPRCompliance.prototype.init=function(){if(this._config.enabled&&!this._initialized){if(this._loadStoredConsent(),this._privacySettings.respectDoNotTrack&&this._hasDoNotTrack())return this._handleDoNotTrack(),this._initialized=!0,void this.emit("gdpr:initialized",this._config);this._shouldShowBanner()&&this.showConsentBanner(),this._initialized=!0,this.emit("gdpr:initialized",this._config)}},GDPRCompliance.prototype.showConsentBanner=function(){var _a;isBrowser()&&(null===(_a=this._config.consentBanner)||void 0===_a?void 0:_a.enabled)?(this._createBannerElement(),this.emit("banner:shown")):this.emit("banner:shown")},GDPRCompliance.prototype.hideConsentBanner=function(){this._bannerElement&&(this._bannerElement.remove(),this._bannerElement=null,this.emit("banner:hidden"))},GDPRCompliance.prototype.getConsent=function(){return this._consent},GDPRCompliance.prototype.setConsent=function(consent){var _this=this,newConsent=__assign({id:generateId(),hasConsent:!0,timestamp:now(),version:"1.0",method:"banner",categories:{},legalBasis:{},purposes:{analytics:!1,marketing:!1,functional:!0,advertising:!1,personalization:!1}},consent);Object.keys(newConsent.categories).forEach(function(categoryId){if(_this._cookieCategories.find(function(c){return c.id===categoryId})&&newConsent.categories[categoryId])switch(categoryId){case"analytics":newConsent.purposes.analytics=!0;break;case"marketing":newConsent.purposes.marketing=!0;break;case"advertising":newConsent.purposes.advertising=!0;break;case"personalization":newConsent.purposes.personalization=!0}}),this._consent=newConsent,this._storeConsent(),this.hideConsentBanner(),this.emit("consent:updated",newConsent)},GDPRCompliance.prototype.withdrawConsent=function(category){var _this=this;if(this._consent){if(category)switch(this._consent.categories[category]=!1,category){case"analytics":this._consent.purposes.analytics=!1;break;case"marketing":this._consent.purposes.marketing=!1;break;case"advertising":this._consent.purposes.advertising=!1;break;case"personalization":this._consent.purposes.personalization=!1}else this._consent.hasConsent=!1,this._consent.withdrawalDate=now(),Object.keys(this._consent.categories).forEach(function(cat){_this._consent.categories[cat]=!1}),this._consent.purposes={analytics:!1,marketing:!1,functional:!0,advertising:!1,personalization:!1};this._storeConsent(),this.emit("consent:withdrawn",{category:category,consent:this._consent})}},GDPRCompliance.prototype.renewConsent=function(){this._consent&&(this._consent.renewalRequired=!0,this._storeConsent()),this.showConsentBanner(),this.emit("consent:renewal_required")},GDPRCompliance.prototype.getCookieCategories=function(){return this._cookieCategories},GDPRCompliance.prototype.setCookieCategory=function(categoryId,enabled){var category=this._cookieCategories.find(function(c){return c.id===categoryId});category&&!category.required&&(category.enabled=enabled,this._consent&&(this._consent.categories[categoryId]=enabled,this._storeConsent()),this.emit("cookie:category_changed",{categoryId:categoryId,enabled:enabled}))},GDPRCompliance.prototype.clearCookies=function(category){isBrowser()&&((category?this._cookieCategories.filter(function(c){return c.id===category}):this._cookieCategories.filter(function(c){return!c.enabled&&!c.required})).forEach(function(cat){cat.cookies.forEach(function(cookie){document.cookie="".concat(cookie.name,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=").concat(cookie.domain||window.location.hostname)})}),this.emit("cookies:cleared",{category:category}))},GDPRCompliance.prototype.requestDataAccess=function(email){return __awaiter(this,void 0,void 0,function(){var request,_a;return __generator(this,function(_b){if(!(null===(_a=this._config.userRights)||void 0===_a?void 0:_a.enableDataAccess))throw new Error("Data access requests are not enabled");return request=__assign(__assign({id:generateId(),type:"access",timestamp:now(),visitorId:this._getVisitorId()},email&&{email:email}),{status:"pending",expiresAt:now()+2592e6}),this.emit("data:access_requested",request),[2,request]})})},GDPRCompliance.prototype.requestDataDeletion=function(email){return __awaiter(this,void 0,void 0,function(){var request,_a;return __generator(this,function(_b){if(!(null===(_a=this._config.userRights)||void 0===_a?void 0:_a.enableDataDeletion))throw new Error("Data deletion requests are not enabled");return request=__assign(__assign({id:generateId(),type:"deletion",timestamp:now(),visitorId:this._getVisitorId()},email&&{email:email}),{status:"pending",expiresAt:now()+2592e6}),this.emit("data:deletion_requested",request),[2,request]})})},GDPRCompliance.prototype.requestDataPortability=function(email){return __awaiter(this,void 0,void 0,function(){var request,_a;return __generator(this,function(_b){if(!(null===(_a=this._config.userRights)||void 0===_a?void 0:_a.enableDataPortability))throw new Error("Data portability requests are not enabled");return request=__assign(__assign({id:generateId(),type:"portability",timestamp:now(),visitorId:this._getVisitorId()},email&&{email:email}),{status:"pending",expiresAt:now()+2592e6}),this.emit("data:portability_requested",request),[2,request]})})},GDPRCompliance.prototype.getPrivacySettings=function(){return __assign({},this._privacySettings)},GDPRCompliance.prototype.setPrivacySettings=function(settings){this._privacySettings=__assign(__assign({},this._privacySettings),settings),this.emit("privacy:settings_updated",this._privacySettings)},GDPRCompliance.prototype.anonymizeData=function(data){if(!this._privacySettings.dataMinimization)return data;var anonymized=__assign({},data);return this._privacySettings.anonymizeIPs&&anonymized.ip&&(anonymized.ip=this._anonymizeIP(anonymized.ip)),["email","phone","name","address","ssn"].forEach(function(field){anonymized[field]&&delete anonymized[field]}),anonymized},GDPRCompliance.prototype.isCompliant=function(){return!this._config.enabled||!(this._privacySettings.consentRequired&&!this._hasValidConsent())&&!!this._isDataRetentionCompliant()},GDPRCompliance.prototype.getComplianceReport=function(){var issues=[],recommendations=[],consentStatus="missing";this._consent?this._consent.withdrawalDate?consentStatus="withdrawn":this._isConsentExpired()?(consentStatus="expired",issues.push("Consent has expired and needs renewal")):consentStatus="valid":issues.push("No consent record found");var dataRetentionCompliant=this._isDataRetentionCompliant();dataRetentionCompliant||(issues.push("Data retention period exceeded"),recommendations.push("Implement automatic data deletion"));var cookieCompliant=this._isCookieCompliant();return cookieCompliant||(issues.push("Non-essential cookies active without consent"),recommendations.push("Review cookie categorization and consent status")),{timestamp:now(),consentStatus:consentStatus,dataRetentionCompliance:dataRetentionCompliant,cookieCompliance:cookieCompliant,privacySettingsCompliance:!0,issues:issues,recommendations:recommendations}},GDPRCompliance.prototype.exportUserData=function(visitorId){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,{visitorId:visitorId,exportDate:now(),sessions:[],events:[],pageViews:[],consent:this._consent?[this._consent]:[],format:"json"}]})})},GDPRCompliance.prototype.deleteUserData=function(visitorId){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){try{return this._storage.removeItem("gdpr_consent_".concat(visitorId)),this._storage.removeItem("visitor_session_".concat(visitorId)),this._consent&&(this._consent=null),this.emit("data:deleted",{visitorId:visitorId}),[2,!0]}catch(error){return this.emit("data:deletion_failed",{visitorId:visitorId,error:error}),[2,!1]}return[2]})})},GDPRCompliance.prototype.destroy=function(){this.hideConsentBanner(),this._initialized=!1,this.emit("gdpr:destroyed")},GDPRCompliance.prototype._getDefaultCookieCategories=function(){return[{id:"necessary",name:"Necessary",description:"These cookies are essential for the website to function properly.",required:!0,enabled:!0,purpose:"Essential website functionality",legalBasis:{type:"legitimate_interests",description:"Necessary for website operation",legitimateInterests:"Providing requested services"},retentionPeriod:365,cookies:[{name:"session_id",purpose:"Session management",provider:"First party",expiry:"Session",type:"essential"}]},{id:"analytics",name:"Analytics",description:"These cookies help us understand how visitors interact with our website.",required:!1,enabled:!1,purpose:"Website analytics and improvement",legalBasis:{type:"consent",description:"User consent for analytics"},retentionPeriod:730,cookies:[{name:"tracking_id",purpose:"Visitor tracking",provider:"First party",expiry:"2 years",type:"analytics"}]},{id:"marketing",name:"Marketing",description:"These cookies are used to show relevant advertising and marketing content.",required:!1,enabled:!1,purpose:"Personalized advertising",legalBasis:{type:"consent",description:"User consent for marketing"},retentionPeriod:365,cookies:[{name:"marketing_id",purpose:"Marketing campaigns",provider:"Third party",expiry:"1 year",type:"marketing"}]}]},GDPRCompliance.prototype._loadStoredConsent=function(){try{var stored=this._storage.getItem("gdpr_consent");stored&&(this._consent=JSON.parse(stored))}catch(error){}},GDPRCompliance.prototype._storeConsent=function(){this._consent&&this._storage.setItem("gdpr_consent",JSON.stringify(this._consent))},GDPRCompliance.prototype._shouldShowBanner=function(){var _a,_b;return!(!(null===(_a=this._config.consentBanner)||void 0===_a?void 0:_a.enabled)||this._hasValidConsent()&&!(null===(_b=this._consent)||void 0===_b?void 0:_b.renewalRequired)||this._hasDoNotTrack()&&this._privacySettings.respectDoNotTrack)},GDPRCompliance.prototype._hasValidConsent=function(){return null!==this._consent&&this._consent.hasConsent&&!this._consent.withdrawalDate&&!this._isConsentExpired()},GDPRCompliance.prototype._isConsentExpired=function(){if(!this._consent)return!0;var expiryTime=this._consent.timestamp+31536e6;return now()>expiryTime},GDPRCompliance.prototype._hasDoNotTrack=function(){return!!isBrowser()&&("1"===navigator.doNotTrack||"1"===window.doNotTrack||"1"===navigator.msDoNotTrack)},GDPRCompliance.prototype._handleDoNotTrack=function(){this.setConsent({hasConsent:!1,method:"implied",categories:{},purposes:{analytics:!1,marketing:!1,functional:!0,advertising:!1,personalization:!1}}),this.emit("consent:do_not_track")},GDPRCompliance.prototype._createBannerElement=function(){if(isBrowser()&&!this._bannerElement){var banner=document.createElement("div");banner.className="gdpr-banner",banner.innerHTML=this._getBannerHTML(),this._applyBannerStyles(banner),this._addBannerEventListeners(banner),document.body.appendChild(banner),this._bannerElement=banner}},GDPRCompliance.prototype._getBannerHTML=function(){var _a,texts=(null===(_a=this._config.consentBanner)||void 0===_a?void 0:_a.texts)||this._defaultTexts;return'\n      <div class="gdpr-banner-content">\n        <div class="gdpr-banner-text">\n          <h3>'.concat(texts.bannerTitle,"</h3>\n          <p>").concat(texts.bannerDescription,'</p>\n        </div>\n        <div class="gdpr-banner-actions">\n          <button type="button" class="gdpr-btn gdpr-btn-customize">').concat(texts.customize,'</button>\n          <button type="button" class="gdpr-btn gdpr-btn-reject">').concat(texts.rejectAll,'</button>\n          <button type="button" class="gdpr-btn gdpr-btn-accept">').concat(texts.acceptAll,"</button>\n        </div>\n      </div>\n    ")},GDPRCompliance.prototype._applyBannerStyles=function(banner){var _a,_b,_c,position=(null===(_a=this._config.consentBanner)||void 0===_a?void 0:_a.position)||"bottom",theme=(null===(_b=this._config.consentBanner)||void 0===_b?void 0:_b.theme)||"light",baseStyles={position:"fixed",left:"0",right:"0",zIndex:"10000",backgroundColor:"dark"===theme?"#2d3748":"#ffffff",color:"dark"===theme?"#ffffff":"#2d3748",padding:"16px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",fontFamily:"-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif",fontSize:"14px",lineHeight:"1.4"};"top"===position?baseStyles.top="0":baseStyles.bottom="0",Object.assign(banner.style,baseStyles,null===(_c=this._config.consentBanner)||void 0===_c?void 0:_c.customStyles);var content=banner.querySelector(".gdpr-banner-content");content&&Object.assign(content.style,{display:"flex",alignItems:"center",justifyContent:"space-between",maxWidth:"1200px",margin:"0 auto",gap:"16px"}),banner.querySelectorAll(".gdpr-btn").forEach(function(btn){var button=btn;Object.assign(button.style,{padding:"8px 16px",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",marginLeft:"8px"}),button.classList.contains("gdpr-btn-accept")?Object.assign(button.style,{backgroundColor:"#4299e1",color:"#ffffff"}):button.classList.contains("gdpr-btn-reject")?Object.assign(button.style,{backgroundColor:"transparent",color:"dark"===theme?"#ffffff":"#4a5568",border:"1px solid currentColor"}):Object.assign(button.style,{backgroundColor:"transparent",color:"dark"===theme?"#ffffff":"#4a5568",textDecoration:"underline"})})},GDPRCompliance.prototype._addBannerEventListeners=function(banner){var _this=this,acceptBtn=banner.querySelector(".gdpr-btn-accept"),rejectBtn=banner.querySelector(".gdpr-btn-reject"),customizeBtn=banner.querySelector(".gdpr-btn-customize");acceptBtn&&acceptBtn.addEventListener("click",function(){_this.setConsent({hasConsent:!0,method:"banner",categories:Object.fromEntries(_this._cookieCategories.map(function(cat){return[cat.id,!cat.required||cat.enabled]}))})}),rejectBtn&&rejectBtn.addEventListener("click",function(){_this.setConsent({hasConsent:!1,method:"banner",categories:Object.fromEntries(_this._cookieCategories.map(function(cat){return[cat.id,cat.required]}))})}),customizeBtn&&customizeBtn.addEventListener("click",function(){_this._showCustomizeModal()})},GDPRCompliance.prototype._showCustomizeModal=function(){this.emit("banner:customize_requested",this._cookieCategories)},GDPRCompliance.prototype._isDataRetentionCompliant=function(){if(!this._consent)return!0;var retentionDays=this._privacySettings.dataRetentionDays;return now()-this._consent.timestamp<=24*retentionDays*60*60*1e3},GDPRCompliance.prototype._isCookieCompliant=function(){var _this=this;return!!this._consent&&this._cookieCategories.every(function(category){if(category.required)return!0;var consentForCategory=_this._consent.categories[category.id];return void 0!==consentForCategory?category.enabled===consentForCategory:!category.enabled})},GDPRCompliance.prototype._anonymizeIP=function(ip){return ip.includes(":")?ip.split(":").slice(0,4).join(":")+"::":ip.split(".").slice(0,3).join(".")+".0"},GDPRCompliance.prototype._getVisitorId=function(){return"visitor_"+generateId()},GDPRCompliance}(EventEmitter),globalTracker=null;function init(config){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return globalTracker||(globalTracker=new Tracker),[4,globalTracker.init(config)];case 1:return _a.sent(),[2,globalTracker]}})})}function getTracker(){return globalTracker}function track(event,data){globalTracker&&globalTracker.track(event,data)}function pageView(data){globalTracker&&globalTracker.pageView(data)}function identify(visitorId,traits){globalTracker&&globalTracker.identify(visitorId,traits)}function setConsent(consent){globalTracker&&globalTracker.setConsent(consent)}function createTracker(config){var tracker=new Tracker;return config&&config.apiUrl&&config.projectId&&tracker.init(config).catch(function(error){config.debug&&console.error("Failed to initialize tracker:",error)}),tracker}if(isBrowser()){var globalWindow=window;globalWindow.optimizelyConfig&&init(globalWindow.optimizelyConfig),globalWindow.Optimizely={init:init,getTracker:getTracker,track:track,pageView:pageView,identify:identify,setConsent:setConsent,createTracker:createTracker,Tracker:Tracker}}var index={init:init,getTracker:getTracker,track:track,pageView:pageView,identify:identify,setConsent:setConsent,createTracker:createTracker,Tracker:Tracker};export{BehavioralTracker,EventEmitter,GDPRCompliance,SessionManager,Storage,TechnologyDetector,Tracker,WebSocketManager,addEventListener,anonymizeIP,anonymizeIPv4,anonymizeIPv6,areCookiesEnabled,calculateRetentionExpiry,clearAllCookies,createTracker,debounce,deepMerge,index as default,detectBrowser,detectPlatform,domReady,formatGDPRDate,generateId,generateSessionId,generateVisitorId,getCurrentTitle,getCurrentUrl,getDoNotTrackStatus,getLanguage,getPlatform,getReferrer,getScrollDepth,getTimezoneOffset,getTracker,getUserAgent,hashSensitiveData,identify,init,isBrowser,isConsentRequired,isDataExpired,isElementVisible,isProduction,isValidEmail,now,pageView,removePII,safeJsonParse,safeJsonStringify,setConsent,shouldAnonymizeIP,shouldMinimizeData,simpleHash,throttle,track};
//# sourceMappingURL=tracker.esm.js.map
